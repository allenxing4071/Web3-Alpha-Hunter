# 平台监控系统文档

> **功能状态**: ✅ 已完成
> **最后更新**: 2025-10-13
> **完成度**: 85%

---

## 📋 概述

平台监控系统是Web3 Alpha Hunter的数据采集引擎，负责从Twitter、Telegram、Discord等平台自动监控和采集Web3项目相关信息。

### 核心功能

1. ✅ 多平台搜索规则配置
2. ✅ Twitter关键词监控
3. ✅ Telegram频道监控
4. ✅ Discord服务器监控
5. ✅ 平台数据统计分析
6. 🚧 自动化采集引擎 (部分实现)

---

## 🗄️ 数据库设计

### 1. platform_search_rules (平台搜索规则表)

**用途**: 配置各平台的搜索规则和监控策略

**字段** (12个):

```sql
CREATE TABLE platform_search_rules (
    id SERIAL PRIMARY KEY,

    -- 平台信息
    platform VARCHAR(50) NOT NULL,  -- twitter, telegram, discord, youtube
    rule_name VARCHAR(255) NOT NULL,  -- 规则名称
    rule_type VARCHAR(50),  -- keyword, hashtag, user, channel

    -- 搜索配置
    search_query TEXT NOT NULL,  -- 搜索查询
    filters JSONB,  -- 过滤条件
    frequency VARCHAR(50),  -- 采集频率: realtime, hourly, daily

    -- 优先级
    priority INTEGER DEFAULT 5,  -- 1-10, 数字越大优先级越高

    -- 状态
    is_active BOOLEAN DEFAULT true,
    last_run_at TIMESTAMP,

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_rules_platform ON platform_search_rules(platform, is_active);
CREATE INDEX idx_rules_priority ON platform_search_rules(priority DESC);
```

**配置示例**:

```json
// Twitter关键词监控规则
{
  "platform": "twitter",
  "rule_name": "新项目发现-空投关键词",
  "rule_type": "keyword",
  "search_query": "airdrop OR presale OR testnet OR mainnet launch",
  "filters": {
    "language": "en",
    "min_followers": 1000,
    "exclude_retweets": false
  },
  "frequency": "realtime",
  "priority": 9
}

// Telegram频道监控规则
{
  "platform": "telegram",
  "rule_name": "顶级加密频道监控",
  "rule_type": "channel",
  "search_query": "@crypto_alpha_signals",
  "filters": {
    "message_types": ["text", "photo"],
    "min_members": 10000
  },
  "frequency": "realtime",
  "priority": 10
}
```

---

### 2. twitter_keywords (Twitter关键词库)

**用途**: 存储Twitter监控的关键词和标签

**字段** (11个):

```sql
CREATE TABLE twitter_keywords (
    id SERIAL PRIMARY KEY,

    -- 关键词信息
    keyword VARCHAR(255) NOT NULL UNIQUE,
    keyword_type VARCHAR(50),  -- hashtag, mention, keyword
    category VARCHAR(100),  -- DeFi, NFT, GameFi, Airdrop等

    -- 监控配置
    is_active BOOLEAN DEFAULT true,
    priority INTEGER DEFAULT 5,
    search_filters JSONB,

    -- 统计数据
    total_mentions INTEGER DEFAULT 0,
    last_mention_at TIMESTAMP,

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_keywords_active ON twitter_keywords(is_active, priority DESC);
CREATE INDEX idx_keywords_category ON twitter_keywords(category);
```

**内置关键词库**:

```python
# 空投相关
AIRDROP_KEYWORDS = [
    "airdrop", "空投", "free tokens", "token giveaway",
    "claim airdrop", "snapshot", "eligibility"
]

# 新项目发现
NEW_PROJECT_KEYWORDS = [
    "presale", "fair launch", "new token", "launching soon",
    "testnet", "mainnet", "beta launch", "early access"
]

# DeFi相关
DEFI_KEYWORDS = [
    "yield farming", "liquidity mining", "staking rewards",
    "TVL", "DEX", "AMM", "lending protocol"
]

# Layer2/链相关
BLOCKCHAIN_KEYWORDS = [
    "Layer2", "L2", "rollup", "zk-rollup", "optimistic rollup",
    "sidechain", "cross-chain", "bridge"
]

# 融资/投资
FUNDING_KEYWORDS = [
    "seed round", "Series A", "funding raised", "VC investment",
    "a16z", "Paradigm", "Binance Labs"
]
```

---

### 3. telegram_channels (Telegram频道监控表)

**用途**: 管理监控的Telegram频道和群组

**字段** (15个):

```sql
CREATE TABLE telegram_channels (
    id SERIAL PRIMARY KEY,

    -- 频道信息
    channel_id VARCHAR(255) UNIQUE,  -- @channel_username 或 chat_id
    channel_name VARCHAR(255),
    channel_type VARCHAR(50),  -- channel, group, supergroup
    channel_url VARCHAR(500),

    -- 频道特征
    category VARCHAR(100),  -- Official, KOL, Community, News
    language VARCHAR(20) DEFAULT 'en',
    member_count INTEGER,

    -- 监控配置
    is_active BOOLEAN DEFAULT true,
    priority INTEGER DEFAULT 5,
    monitor_keywords JSONB,  -- 关注的关键词

    -- 统计数据
    total_messages INTEGER DEFAULT 0,
    last_message_at TIMESTAMP,

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_channels_active ON telegram_channels(is_active, priority DESC);
CREATE INDEX idx_channels_category ON telegram_channels(category);
```

**顶级频道列表**:

| 频道名称 | 类型 | 成员数 | 分类 | 优先级 |
|---------|------|--------|------|--------|
| @crypto_alpha_signals | Channel | 50K+ | KOL | 10 |
| @binance_announcements | Official | 500K+ | Official | 10 |
| @coinbase_official | Official | 300K+ | Official | 9 |
| @uniswap_community | Community | 100K+ | Community | 8 |
| @airdrop_alerts | Channel | 80K+ | Airdrop | 9 |

---

### 4. discord_servers (Discord服务器监控表)

**用途**: 管理监控的Discord服务器

**字段** (14个):

```sql
CREATE TABLE discord_servers (
    id SERIAL PRIMARY KEY,

    -- 服务器信息
    server_id VARCHAR(255) UNIQUE,
    server_name VARCHAR(255),
    server_url VARCHAR(500),

    -- 服务器特征
    category VARCHAR(100),  -- Official, Community, DAO
    member_count INTEGER,
    online_members INTEGER,

    -- 监控配置
    is_active BOOLEAN DEFAULT true,
    priority INTEGER DEFAULT 5,
    monitored_channels JSONB,  -- 监控的频道列表

    -- 统计数据
    total_messages INTEGER DEFAULT 0,
    last_activity_at TIMESTAMP,

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_discord_active ON discord_servers(is_active, priority DESC);
CREATE INDEX idx_discord_category ON discord_servers(category);
```

---

### 5. platform_daily_stats (平台每日统计表)

**用途**: 记录各平台每日采集数据统计

**字段** (16个):

```sql
CREATE TABLE platform_daily_stats (
    id SERIAL PRIMARY KEY,

    -- 日期和平台
    stat_date DATE NOT NULL,
    platform VARCHAR(50) NOT NULL,

    -- 采集统计
    total_messages INTEGER DEFAULT 0,
    unique_projects INTEGER DEFAULT 0,
    new_projects INTEGER DEFAULT 0,

    -- 项目分类统计
    defi_mentions INTEGER DEFAULT 0,
    nft_mentions INTEGER DEFAULT 0,
    gamefi_mentions INTEGER DEFAULT 0,
    layer2_mentions INTEGER DEFAULT 0,

    -- 质量统计
    high_quality_signals INTEGER DEFAULT 0,  -- 高质量信号数
    false_positives INTEGER DEFAULT 0,  -- 误报数

    -- KOL统计
    kol_mentions INTEGER DEFAULT 0,
    trending_topics JSONB,  -- 热门话题

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(stat_date, platform)
);

CREATE INDEX idx_stats_date ON platform_daily_stats(stat_date DESC);
CREATE INDEX idx_stats_platform ON platform_daily_stats(platform, stat_date DESC);
```

---

## 📊 API接口

### 1. 获取监控规则列表

```http
GET /api/v1/monitoring/rules
```

**查询参数**:
- `platform` - 平台筛选 (twitter/telegram/discord)
- `is_active` - 是否启用
- `priority` - 最低优先级

**响应示例**:
```json
{
  "success": true,
  "data": {
    "rules": [
      {
        "id": 1,
        "platform": "twitter",
        "rule_name": "新项目发现-空投关键词",
        "search_query": "airdrop OR presale OR testnet",
        "frequency": "realtime",
        "priority": 9,
        "is_active": true
      }
    ],
    "total": 15
  }
}
```

---

### 2. 创建监控规则

```http
POST /api/v1/monitoring/rules
```

**权限**: 管理员

**请求体**:
```json
{
  "platform": "twitter",
  "rule_name": "DeFi新协议监控",
  "rule_type": "keyword",
  "search_query": "new DeFi protocol OR DeFi launch",
  "filters": {
    "language": "en",
    "min_followers": 5000
  },
  "frequency": "hourly",
  "priority": 8
}
```

---

### 3. 获取Twitter关键词库

```http
GET /api/v1/monitoring/twitter/keywords
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "keywords": [
      {
        "keyword": "airdrop",
        "category": "Airdrop",
        "total_mentions": 15230,
        "is_active": true
      },
      {
        "keyword": "presale",
        "category": "New Project",
        "total_mentions": 8420,
        "is_active": true
      }
    ],
    "total": 127
  }
}
```

---

### 4. 获取Telegram频道列表

```http
GET /api/v1/monitoring/telegram/channels
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "channels": [
      {
        "channel_id": "@crypto_alpha_signals",
        "channel_name": "Crypto Alpha Signals",
        "category": "KOL",
        "member_count": 52000,
        "priority": 10,
        "is_active": true
      }
    ],
    "total": 45
  }
}
```

---

### 5. 获取平台统计数据

```http
GET /api/v1/monitoring/stats
```

**查询参数**:
- `platform` - 平台
- `start_date` - 开始日期
- `end_date` - 结束日期

**响应示例**:
```json
{
  "success": true,
  "data": {
    "stats": [
      {
        "stat_date": "2025-10-13",
        "platform": "twitter",
        "total_messages": 1523,
        "unique_projects": 47,
        "new_projects": 12,
        "high_quality_signals": 8
      }
    ],
    "summary": {
      "total_messages": 4569,
      "avg_daily_projects": 38,
      "total_new_projects": 35
    }
  }
}
```

---

## 🔄 数据采集流程

### Twitter监控流程

```
┌─────────────────┐
│  加载搜索规则   │
│ (active rules)  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  执行Twitter    │
│  API搜索        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  过滤与去重     │
│ - 语言过滤      │
│ - 粉丝数过滤    │
│ - 去除重复推文  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  提取项目信息   │
│ - 项目名称      │
│ - 合约地址      │
│ - 官网链接      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  写入发现表     │
│ project_        │
│ discoveries     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  AI初步分析     │
│ (可选)          │
└─────────────────┘
```

### Telegram监控流程

```
┌─────────────────┐
│  订阅目标频道   │
│ (45+ channels)  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  实时接收消息   │
│ (Telegram Bot)  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  关键词匹配     │
│ - 项目名称      │
│ - 空投信息      │
│ - 合约地址      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  信息提取       │
│ - 链接提取      │
│ - 图片OCR       │
│ - 文本分析      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  存储与通知     │
│ - 写入数据库    │
│ - 高优先级推送  │
└─────────────────┘
```

---

## 🤖 自动化采集引擎

### Celery任务调度

**配置文件**: `backend/app/tasks/celery.py`

```python
from celery import Celery
from celery.schedules import crontab

app = Celery('web3_alpha_hunter')

# 定时任务
app.conf.beat_schedule = {
    # Twitter关键词扫描 (每5分钟)
    'scan-twitter-keywords': {
        'task': 'app.tasks.twitter.scan_keywords',
        'schedule': 300.0,  # 5分钟
    },

    # Telegram消息采集 (实时)
    'collect-telegram-messages': {
        'task': 'app.tasks.telegram.collect_messages',
        'schedule': 60.0,  # 1分钟
    },

    # 每日统计汇总 (每天凌晨1点)
    'generate-daily-stats': {
        'task': 'app.tasks.stats.generate_daily_stats',
        'schedule': crontab(hour=1, minute=0),
    },

    # 项目热度更新 (每小时)
    'update-project-heat': {
        'task': 'app.tasks.analysis.update_project_heat',
        'schedule': 3600.0,  # 1小时
    },
}
```

### Twitter采集任务

```python
# app/tasks/twitter.py

@app.task
def scan_keywords():
    """扫描Twitter关键词"""

    # 1. 加载激活的关键词
    keywords = TwitterKeyword.query.filter_by(is_active=True).all()

    for keyword in keywords:
        try:
            # 2. 调用Twitter API
            tweets = search_twitter(
                query=keyword.keyword,
                filters=keyword.search_filters,
                limit=100
            )

            # 3. 处理推文
            for tweet in tweets:
                # 提取项目信息
                project_info = extract_project_info(tweet)

                if project_info:
                    # 写入发现表
                    create_or_update_discovery(project_info)

            # 4. 更新统计
            keyword.total_mentions += len(tweets)
            keyword.last_mention_at = datetime.now()
            db.session.commit()

        except Exception as e:
            logger.error(f"关键词扫描失败 {keyword.keyword}: {e}")
```

### Telegram采集任务

```python
# app/tasks/telegram.py

@app.task
def collect_messages():
    """采集Telegram消息"""

    # 1. 加载激活的频道
    channels = TelegramChannel.query.filter_by(is_active=True).all()

    for channel in channels:
        try:
            # 2. 获取最新消息
            messages = get_telegram_messages(
                channel_id=channel.channel_id,
                limit=50
            )

            # 3. 处理消息
            for msg in messages:
                # 关键词匹配
                if match_keywords(msg.text, channel.monitor_keywords):
                    # 提取信息
                    extracted = extract_telegram_info(msg)

                    # 写入发现表
                    create_or_update_discovery(extracted)

            # 4. 更新统计
            channel.total_messages += len(messages)
            channel.last_message_at = datetime.now()
            db.session.commit()

        except Exception as e:
            logger.error(f"Telegram采集失败 {channel.channel_id}: {e}")
```

---

## 📈 数据质量控制

### 去重机制

```python
def is_duplicate_discovery(project_name, platform, timeframe=24):
    """检查是否重复发现"""

    existing = ProjectDiscovery.query.filter(
        ProjectDiscovery.project_name == project_name,
        ProjectDiscovery.discovered_at >= datetime.now() - timedelta(hours=timeframe)
    ).first()

    return existing is not None
```

### 质量评分

```python
def calculate_quality_score(discovery):
    """计算信号质量分数"""

    score = 0

    # 来源可信度 (0-40分)
    if discovery.platform == 'twitter':
        if discovery.author_followers >= 100000:
            score += 40
        elif discovery.author_followers >= 10000:
            score += 30
        else:
            score += 20

    # 信息完整度 (0-30分)
    has_website = bool(discovery.extracted_info.get('website'))
    has_contract = bool(discovery.extracted_info.get('contract_address'))
    has_description = bool(discovery.extracted_info.get('description'))

    score += sum([has_website, has_contract, has_description]) * 10

    # 热度指标 (0-30分)
    if discovery.total_mentions >= 50:
        score += 30
    elif discovery.total_mentions >= 20:
        score += 20
    elif discovery.total_mentions >= 10:
        score += 10

    return min(score, 100)
```

---

## 🎯 监控策略

### 高优先级监控

**Twitter**:
- 顶级KOL推文 (粉丝>100K)
- 官方公告账号
- 融资消息 (#funding, #raised)

**Telegram**:
- 官方频道公告
- 顶级Alpha频道
- 知名VC群组

**Discord**:
- 项目官方服务器
- DAO治理频道

### 实时预警

触发条件:
```python
# 立即推送通知
if (
    signal_strength >= 90 or
    (is_kol_mention and kol.tier == 'S') or
    (platform == 'official' and category == 'airdrop')
):
    send_realtime_alert(discovery)
```

---

## 📊 统计分析

### 每日数据报告

```python
def generate_daily_report(date):
    """生成每日监控报告"""

    stats = PlatformDailyStat.query.filter_by(stat_date=date).all()

    report = {
        "date": date,
        "platforms": {},
        "summary": {
            "total_messages": 0,
            "new_projects": 0,
            "high_quality_signals": 0
        }
    }

    for stat in stats:
        report["platforms"][stat.platform] = {
            "messages": stat.total_messages,
            "projects": stat.unique_projects,
            "new": stat.new_projects,
            "quality_signals": stat.high_quality_signals
        }

        # 汇总
        report["summary"]["total_messages"] += stat.total_messages
        report["summary"]["new_projects"] += stat.new_projects
        report["summary"]["high_quality_signals"] += stat.high_quality_signals

    return report
```

---

## 🚀 未来优化

### 高优先级
- [ ] YouTube视频转录与分析
- [ ] GitHub活跃度监控
- [ ] 智能反垃圾过滤

### 中优先级
- [ ] 多语言支持 (中文、韩文、日文)
- [ ] 情绪分析引擎
- [ ] 自动化关键词挖掘

### 低优先级
- [ ] Reddit监控
- [ ] Medium文章分析
- [ ] Podcast转录

---

**文档维护**: 技术团队
**最后更新**: 2025-10-13
**状态**: ✅ 核心功能完成，采集引擎待完善
