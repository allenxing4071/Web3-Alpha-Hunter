# 数据库设计文档 - 完整版

> **最后更新**: 2025-10-13
> **文档版本**: v2.0
> **数据库**: PostgreSQL 14 (Docker)

---

## 📊 概览

### 技术栈
- **数据库**: PostgreSQL 14 (Docker容器: web3-postgres)
- **ORM**: SQLAlchemy 2.0
- **迁移工具**: Alembic
- **连接池**: SQLAlchemy Pool (pool_size=20)

### 当前状态
- ✅ **业务表**: 21个
- 📊 **系统表**: 1个 (alembic_version)
- 💾 **总数据量**: ~1.8 MB
- 📈 **项目数据**: 77个项目, 15个KOL, 154条指标

---

## 📋 表分类概览

### 核心业务表 (4个)
1. `projects` - 项目主表 (36列, 77条, 384 KB)
2. `social_metrics` - 社交指标 (19列, 154条, 72 KB)
3. `onchain_metrics` - 链上指标 (20列, 154条, 72 KB)
4. `ai_analysis` - AI分析 (21列, 75条, 136 KB)

### 用户与权限 (1个)
5. `users` - 用户表 (9列, 2条, 112 KB)

### AI系统 (3个)
6. `ai_configs` - AI配置 (7列, 3条, 48 KB)
7. `ai_work_config` - AI工作配置 (13列, 32 KB)
8. `ai_learning_feedback` - AI学习反馈 (9列, 64 KB)

### 预测与投资 (4个)
9. `token_launch_predictions` - 代币发币预测 (15列, 64 KB)
10. `airdrop_value_estimates` - 空投价值估算 (14列, 56 KB)
11. `investment_action_plans` - 投资行动计划 (21列, 64 KB)
12. `project_discoveries` - 项目发现 (20列, 96 KB)

### KOL管理 (3个)
13. `kols` - KOL列表 (24列, 15条, 96 KB)
14. `kols_pending` - 待审核KOL (18列, 32 KB)
15. `kol_performances` - KOL表现 (10列, 32 KB)

### 审核系统 (1个)
16. `projects_pending` - 待审核项目 (24列, 14条, 112 KB)

### 平台监控 (5个)
17. `platform_search_rules` - 平台搜索规则 (13列, 48 KB)
18. `platform_daily_stats` - 平台日统计 (10列, 56 KB)
19. `twitter_keywords` - Twitter关键词 (9列, 72 KB)
20. `telegram_channels` - Telegram频道 (10列, 40 KB)
21. `discord_servers` - Discord服务器 (12列, 40 KB)

---

## ✅ 详细表结构

### 核心业务表

#### 1. projects (项目主表)

**用途**: 存储Web3项目的完整信息和评分

**字段** (36个):
- **基础信息**: id, name, symbol, blockchain, category, description
- **社交链接**: website, twitter, telegram, discord, github
- **评分体系**: overall_score, team_score, tech_score, community_score, tokenomics_score, market_timing_score, risk_score
- **评级**: grade (S/A/B/C)
- **状态**: status, first_discovered_at, last_updated_at
- **元数据**: logo_url, social_links (JSON), key_highlights (JSON), risk_flags (JSON), metrics (JSON)

**索引**:
```sql
CREATE INDEX idx_projects_grade ON projects(grade);
CREATE INDEX idx_projects_score ON projects(overall_score DESC);
CREATE INDEX idx_projects_blockchain ON projects(blockchain);
CREATE INDEX idx_projects_category ON projects(category);
```

**实现状态**: ✅ 完成 (77条数据)

---

#### 2. social_metrics (社交媒体指标)

**用途**: 存储项目的社交媒体数据时序快照

**字段** (19个):
- **Twitter**: twitter_followers, twitter_engagement_rate, twitter_growth_rate
- **Telegram**: telegram_members, telegram_active_rate, telegram_message_frequency
- **Discord**: discord_members, discord_online_ratio
- **GitHub**: github_stars, github_forks, github_commits_last_week, github_contributors
- **YouTube**: youtube_mentions, youtube_views
- **社区情绪**: community_sentiment
- **时间**: snapshot_time, created_at, updated_at

**索引**:
```sql
CREATE INDEX idx_social_project_time ON social_metrics(project_id, snapshot_time DESC);
```

**实现状态**: ✅ 完成 (154条数据)

---

#### 3. onchain_metrics (链上数据指标)

**用途**: 存储项目的链上数据时序快照

**字段** (20个):
- **市值数据**: market_cap, price_usd, volume_24h
- **供应量**: total_supply, circulating_supply
- **流动性**: liquidity_usd, tvl
- **持有者**: holder_count, top_10_holders_percentage
- **交易**: transaction_count, transaction_volume, active_addresses, unique_wallets_24h
- **合约**: contract_interactions, token_holders
- **时间**: snapshot_time, created_at, updated_at

**索引**:
```sql
CREATE INDEX idx_onchain_project_time ON onchain_metrics(project_id, snapshot_time DESC);
```

**实现状态**: ✅ 完成 (154条数据)

---

#### 4. ai_analysis (AI分析结果)

**用途**: 存储AI对项目的深度分析结果

**字段** (21个):
- **文本分析**: whitepaper_summary, key_features (JSON), similar_projects (JSON)
- **评分**: tech_innovation_score, team_background_score, market_potential_score
- **情感**: sentiment_score, sentiment_label
- **风险**: risk_flags (JSON), risk_factors (JSON), scam_probability
- **建议**: investment_suggestion, position_size, entry_timing, stop_loss_percentage
- **机会**: opportunities (JSON)
- **总结**: summary
- **时间**: analyzed_at, created_at, updated_at

**实现状态**: ✅ 完成 (75条数据)

---

### AI系统表

#### 6. ai_configs (AI配置)

**用途**: 存储AI服务提供商的配置

**字段** (7个):
- id, name, api_key (加密), enabled, model, created_at, updated_at

**支持的AI**: OpenAI, Anthropic, DeepSeek

**实现状态**: ✅ 完成 (3条配置)

---

#### 7. ai_work_config (AI工作配置)

**用途**: 配置AI自动化工作参数

**字段** (13个):
- **目标设置**: primary_goal, target_roi, risk_tolerance
- **评分阈值**: min_ai_score, min_market_cap, max_market_cap
- **数量限制**: max_projects_per_day, max_kols_per_day
- **类别过滤**: preferred_categories (JSON), excluded_categories (JSON)
- **验证规则**: required_cross_validation, min_platforms
- **时间限制**: search_lookback_hours, project_age_limit_days
- **自定义规则**: rules (JSON)

**实现状态**: ✅ 完成

---

#### 8. ai_learning_feedback (AI学习反馈)

**用途**: 收集用户对AI推荐的反馈，用于模型优化

**字段** (9个):
- feedback_type, user_decision, reason, related_project_id, related_kol_id
- feedback_value, user_reason, ai_should_adjust, adjustment_applied
- created_at

**实现状态**: ✅ 完成

---

### 预测与投资表

#### 9. token_launch_predictions (代币发币预测)

**用途**: 预测项目发币概率和时间

**字段** (15个):
- **预测结果**: launch_probability (0-100), confidence, estimated_timeline
- **信号检测**: detected_signals (JSON), signal_count
- **信号详情**: has_snapshot_announced, has_tokenomics_published, has_points_system, has_audit_completed, has_mainnet_live, has_roadmap_token_mention
- **时间**: predicted_at, updated_at

**实现状态**: ✅ 完成

---

#### 10. airdrop_value_estimates (空投价值估算)

**用途**: 估算项目空投的价值

**字段** (14个):
- **估算结果**: estimated_value_usd, estimated_value_cny
- **价值区间**: min_value_usd, max_value_usd
- **置信度**: confidence
- **参考数据**: reference_category, historical_avg, comparable_projects (JSON)
- **调整因子**: tvl_adjustment, funding_adjustment, final_adjustment
- **依据**: basis
- **时间**: estimated_at, updated_at

**实现状态**: ✅ 完成

---

#### 11. investment_action_plans (投资行动计划)

**用途**: AI生成的投资行动计划

**字段** (21个):
- **项目信息**: project_id, project_tier, composite_score
- **预算**: total_budget, budget_breakdown (JSON)
- **时间**: start_date, target_duration, urgency
- **收益**: expected_roi, airdrop_estimate
- **行动**: action_steps (JSON), total_steps
- **监控**: monitoring_metrics (JSON), alert_conditions (JSON)
- **风险**: risks (JSON), stop_loss_conditions (JSON)
- **状态**: status, completion_percentage
- **时间**: created_at, updated_at

**实现状态**: ✅ 完成

---

#### 12. project_discoveries (项目发现)

**用途**: 记录从各平台发现的新项目

**字段** (20个):
- **项目**: project_name, project_id (可选)
- **发现数据**: total_mentions, platform_mentions (JSON), num_platforms
- **信号**: signal_strength, heat_score
- **时间**: first_discovered_at, last_mentioned_at, discovered_at
- **热度**: mentions_24h, mentions_7d, growth_rate, is_trending
- **突发**: is_surge, surge_ratio
- **状态**: has_token, discovery_status
- **样本**: mention_samples (JSON), platforms (JSON)

**实现状态**: ✅ 完成

---

### KOL管理表

#### 13. kols (KOL列表)

**用途**: 存储Web3 KOL的完整信息

**字段** (24个):
- **基础**: id, platform, username, display_name
- **社交数据**: followers, following, tweets_count, account_created_at
- **影响力**: tier (1-3), influence_score, avg_engagement_rate
- **标签**: tags (JSON)
- **提及**: total_mentions, this_week_mentions
- **发现**: discovery_method, discovered_at, discovered_by
- **评估**: prediction_accuracy, quality_score
- **状态**: status, is_verified
- **时间**: last_checked_at, last_updated_at, created_at

**索引**:
```sql
CREATE UNIQUE INDEX ON kols(username);
CREATE INDEX idx_kols_tier ON kols(tier);
CREATE INDEX idx_kols_status ON kols(status);
```

**实现状态**: ✅ 完成 (15个KOL)

---

#### 14. kols_pending (待审核KOL)

**用途**: AI推荐的待审核KOL队列

**字段** (18个):
- 包含kols表的大部分字段
- **AI推荐**: ai_recommendation_score, ai_recommendation_reason
- **来源**: ai_discovery_method, source_tweet_id, source_context
- **审核**: review_status, reviewed_by, reviewed_at, reject_reason

**实现状态**: ✅ 完成

---

#### 15. kol_performances (KOL表现)

**用途**: 追踪KOL的历史推荐表现

**字段** (10个):
- kol_id, predicted_project, prediction_date, did_succeed
- tweet_id, likes, retweets, replies
- evaluation_period_start, evaluation_period_end

**实现状态**: ✅ 完成

---

### 审核系统表

#### 16. projects_pending (待审核项目)

**用途**: AI推荐的待审核项目队列

**字段** (24个):
- 包含projects表的大部分字段
- **AI评分**: ai_score, ai_grade, ai_confidence
- **AI详细评分**: ai_team_score, ai_tech_score, ai_community_score, ai_tokenomics_score, ai_market_score, ai_risk_score
- **AI推荐**: ai_recommendation_reason, ai_extracted_info (JSON)
- **来源**: source_url, source_content
- **审核**: review_status, reviewed_by, reviewed_at, rejection_reason, reject_reason

**实现状态**: ✅ 完成 (14条待审核)

---

### 平台监控表

#### 17. platform_search_rules (平台搜索规则)

**用途**: 配置各平台的搜索和监控规则

**字段** (13个):
- platform, platform_name, enabled
- frequency_minutes, search_keywords (JSON), filters (JSON)
- monitor_kols, monitor_channels
- min_engagement, min_author_followers
- max_results_per_run, priority
- last_search_at, created_at, updated_at

**实现状态**: ✅ 完成

---

#### 18. platform_daily_stats (平台日统计)

**用途**: 记录每日各平台的数据采集统计

**字段** (10个):
- platform, stat_date, data_collected
- kols_discovered, projects_recommended
- projects_approved, projects_rejected
- collections, errors_count
- created_at, updated_at

**实现状态**: ✅ 完成

---

#### 19. twitter_keywords (Twitter关键词)

**用途**: Twitter搜索关键词库

**字段** (9个):
- keyword, priority (1-3), weight
- search_count, hit_count, match_count
- last_used_at, last_matched_at
- created_at, updated_at

**实现状态**: ✅ 完成

---

#### 20. telegram_channels (Telegram频道)

**用途**: Telegram监控频道列表

**字段** (10个):
- channel_id, channel_username, channel_title, channel_type
- member_count, description
- is_official, quality_score
- last_monitored_at, last_checked_at, created_at, updated_at

**实现状态**: ✅ 完成

---

#### 21. discord_servers (Discord服务器)

**用途**: Discord监控服务器列表

**字段** (12个):
- server_id, server_name, invite_link
- member_count, online_count
- related_project, description
- is_official, activity_score
- joined_at, last_monitored_at, last_checked_at
- created_at, updated_at

**实现状态**: ✅ 完成

---

## 🔗 数据关系图

```
┌─────────────┐
│   users     │
└──────┬──────┘
       │ 1:N (管理员审核)
       │
       ▼
┌──────────────────┐          ┌────────────────┐
│ projects_pending │─────────→│   projects     │
└──────────────────┘ 审核通过  └───────┬────────┘
                                      │
                         ┌────────────┼─────────────┬──────────────┐
                         │            │             │              │
                         │ 1:N        │ 1:N         │ 1:N          │ 1:N
                         ▼            ▼             ▼              ▼
              ┌──────────────┐ ┌──────────────┐ ┌──────────┐ ┌──────────────────┐
              │social_metrics│ │onchain_metrics│ │ai_analysis│ │project_discoveries│
              └──────────────┘ └──────────────┘ └──────────┘ └──────────────────┘
                                                     │
                                                     │ 1:N
                                                     ▼
                                          ┌─────────────────────┐
                                          │token_launch_predictions│
                                          │airdrop_value_estimates│
                                          │investment_action_plans│
                                          └─────────────────────┘

┌──────────────┐          ┌────────────┐
│ kols_pending │─────────→│   kols     │
└──────────────┘ 审核通过  └─────┬──────┘
                                 │ 1:N
                                 ▼
                      ┌──────────────────┐
                      │ kol_performances │
                      └──────────────────┘

┌────────────────────┐
│ platform_search_   │
│ rules              │
└────────┬───────────┘
         │ 配置
         ▼
┌────────────────────┐
│ twitter_keywords   │
│ telegram_channels  │
│ discord_servers    │
└────────────────────┘
         │ 采集数据
         ▼
┌────────────────────┐
│platform_daily_stats│
└────────────────────┘
```

---

## 🔍 索引策略

### 核心表索引

```sql
-- projects 表
CREATE INDEX idx_projects_grade ON projects(grade);
CREATE INDEX idx_projects_score ON projects(overall_score DESC);
CREATE INDEX idx_projects_blockchain ON projects(blockchain);
CREATE INDEX idx_projects_category ON projects(category);
CREATE INDEX idx_projects_discovered_at ON projects(first_discovered_at DESC);

-- social_metrics 和 onchain_metrics
CREATE INDEX idx_social_project_time ON social_metrics(project_id, snapshot_time DESC);
CREATE INDEX idx_onchain_project_time ON onchain_metrics(project_id, snapshot_time DESC);

-- kols 表
CREATE UNIQUE INDEX ON kols(username);
CREATE INDEX idx_kols_tier ON kols(tier);
CREATE INDEX idx_kols_status ON kols(status);
CREATE INDEX idx_kols_username ON kols(username);

-- platform_search_rules
CREATE INDEX idx_platform_rules_enabled ON platform_search_rules(enabled, platform);
```

---

## 📊 查询优化示例

### 1. 获取S级项目及其最新指标

```sql
SELECT
    p.*,
    sm.twitter_followers,
    sm.telegram_members,
    om.market_cap,
    om.tvl_usd
FROM projects p
LEFT JOIN LATERAL (
    SELECT * FROM social_metrics
    WHERE project_id = p.id
    ORDER BY snapshot_time DESC
    LIMIT 1
) sm ON true
LEFT JOIN LATERAL (
    SELECT * FROM onchain_metrics
    WHERE project_id = p.id
    ORDER BY snapshot_time DESC
    LIMIT 1
) om ON true
WHERE p.grade = 'S'
ORDER BY p.overall_score DESC;
```

### 2. 获取待审核项目列表

```sql
SELECT
    pp.*,
    u.username as reviewer_name
FROM projects_pending pp
LEFT JOIN users u ON u.id = pp.reviewed_by
WHERE pp.review_status = 'pending'
ORDER BY pp.ai_score DESC, pp.submitted_at ASC;
```

### 3. KOL表现排行榜

```sql
SELECT
    k.username,
    k.followers,
    k.influence_score,
    k.this_week_mentions,
    k.prediction_accuracy,
    COUNT(kp.id) as total_predictions
FROM kols k
LEFT JOIN kol_performances kp ON kp.kol_id = k.id
WHERE k.status = 'active'
GROUP BY k.id
ORDER BY k.influence_score DESC, k.prediction_accuracy DESC
LIMIT 20;
```

---

## 🔐 数据安全

### 加密字段
- `ai_configs.api_key` - 使用Fernet加密
- `users.password_hash` - bcrypt哈希

### 备份策略
- 每日全量备份
- WAL归档启用
- 保留30天历史备份

---

## 📈 数据库性能指标

| 指标 | 当前值 | 目标值 |
|------|--------|--------|
| 表数量 | 22 | - |
| 总数据量 | 1.8 MB | <100 MB |
| 最大表大小 | 384 KB (projects) | <10 MB |
| 索引数量 | ~40 | - |
| 查询响应时间 | <100ms | <200ms |
| 连接池大小 | 20 | 20-50 |

---

**文档版本**: v2.0 (完整版)
**最后更新**: 2025-10-13
**维护人**: 技术团队
