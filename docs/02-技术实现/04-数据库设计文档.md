# æ•°æ®åº“è®¾è®¡æ–‡æ¡£

> **æœ€åæ›´æ–°**: 2025-10-04
> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æ•°æ®åº“**: PostgreSQL 15+

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è§ˆ](#æ¦‚è§ˆ)
2. [å·²å®ç°çš„è¡¨ç»“æ„](#å·²å®ç°çš„è¡¨ç»“æ„)
3. [æ•°æ®åº“è¿ç§»è®°å½•](#æ•°æ®åº“è¿ç§»è®°å½•)
4. [ç´¢å¼•è®¾è®¡](#ç´¢å¼•è®¾è®¡)
5. [æ•°æ®å…³ç³»å›¾](#æ•°æ®å…³ç³»å›¾)
6. [æŸ¥è¯¢ä¼˜åŒ–](#æŸ¥è¯¢ä¼˜åŒ–)

---

## ğŸ“Š æ¦‚è§ˆ

### æŠ€æœ¯æ ˆ
- **æ•°æ®åº“**: PostgreSQL 15+
- **ORM**: SQLAlchemy 2.0
- **è¿ç§»å·¥å…·**: Alembic
- **è¿æ¥æ± **: SQLAlchemy Pool (pool_size=20)

### å½“å‰çŠ¶æ€
- âœ… **å·²å®ç°çš„è¡¨**: 6ä¸ª
- ğŸš§ **å¼€å‘ä¸­çš„è¡¨**: 2ä¸ª
- ğŸ“‹ **è®¡åˆ’ä¸­çš„è¡¨**: 3ä¸ª

---

## âœ… å·²å®ç°çš„è¡¨ç»“æ„

### 1. users (ç”¨æˆ·è¡¨)

**ç”¨é€”**: å­˜å‚¨ç”¨æˆ·è®¤è¯ä¿¡æ¯å’Œè§’è‰²æƒé™

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    hashed_password VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    role VARCHAR(20) DEFAULT 'user',  -- 'admin' æˆ– 'user'
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
```

**å­—æ®µè¯´æ˜**:
- `id`: ä¸»é”®,è‡ªå¢
- `username`: ç”¨æˆ·å,å”¯ä¸€
- `email`: é‚®ç®±,å”¯ä¸€
- `hashed_password`: bcryptåŠ å¯†çš„å¯†ç 
- `role`: è§’è‰² (admin/user)
- `is_active`: è´¦æˆ·æ˜¯å¦æ¿€æ´»

**å®ç°çŠ¶æ€**: âœ… å®Œæˆ

---

### 2. projects (é¡¹ç›®ä¸»è¡¨)

**ç”¨é€”**: å­˜å‚¨Web3é¡¹ç›®çš„åŸºç¡€ä¿¡æ¯å’Œè¯„åˆ†

```sql
CREATE TABLE projects (
    -- ä¸»é”®
    id SERIAL PRIMARY KEY,

    -- åŸºç¡€ä¿¡æ¯
    project_name VARCHAR(255) NOT NULL,
    symbol VARCHAR(50),
    contract_address VARCHAR(255) UNIQUE,
    blockchain VARCHAR(50),
    category VARCHAR(100),  -- DeFi, NFT, GameFi, Infrastructure

    -- æè¿°ä¿¡æ¯
    description TEXT,
    website VARCHAR(500),
    whitepaper_url VARCHAR(500),
    twitter_handle VARCHAR(100),
    telegram_channel VARCHAR(100),
    discord_link VARCHAR(500),
    github_repo VARCHAR(500),
    logo_url VARCHAR(500),

    -- è¯„åˆ†ç›¸å…³ (0-100)
    overall_score DECIMAL(5,2),
    team_score DECIMAL(5,2),
    tech_score DECIMAL(5,2),
    community_score DECIMAL(5,2),
    tokenomics_score DECIMAL(5,2),
    market_timing_score DECIMAL(5,2),
    risk_score DECIMAL(5,2),

    grade VARCHAR(1),  -- S, A, B, C

    -- çŠ¶æ€
    status VARCHAR(50) DEFAULT 'discovered',  -- discovered, analyzing, published, archived
    first_discovered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- å…ƒæ•°æ®
    discovered_from VARCHAR(100),  -- twitter, telegram, youtube, coingecko
    extra_metadata JSON,  -- é¢å¤–çš„çµæ´»æ•°æ®

    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_projects_name ON projects(project_name);
CREATE INDEX idx_projects_score ON projects(overall_score DESC);
CREATE INDEX idx_projects_grade ON projects(grade);
CREATE INDEX idx_projects_blockchain ON projects(blockchain);
CREATE INDEX idx_projects_category ON projects(category);
CREATE INDEX idx_projects_discovered_at ON projects(first_discovered_at DESC);
CREATE INDEX idx_projects_score_grade ON projects(overall_score DESC, grade);
```

**å­—æ®µè¯´æ˜**:
- **åŸºç¡€ä¿¡æ¯**: é¡¹ç›®åç§°ã€ä»£å¸ç¬¦å·ã€åˆçº¦åœ°å€ã€åŒºå—é“¾ã€åˆ†ç±»
- **ç¤¾äº¤é“¾æ¥**: Twitterã€Telegramã€Discordã€GitHubç­‰
- **è¯„åˆ†ä½“ç³»**: 6ç»´åº¦è¯„åˆ† + ç»¼åˆè¯„åˆ† + è¯„çº§
- **çŠ¶æ€ç®¡ç†**: å‘ç°çŠ¶æ€ã€å‘ç°æ—¶é—´ã€æ›´æ–°æ—¶é—´
- **å…ƒæ•°æ®**: JSONæ ¼å¼å­˜å‚¨çµæ´»æ•°æ®

**å®ç°çŠ¶æ€**: âœ… å®Œæˆ

---

### 3. social_metrics (ç¤¾äº¤åª’ä½“æŒ‡æ ‡)

**ç”¨é€”**: å­˜å‚¨é¡¹ç›®çš„ç¤¾äº¤åª’ä½“æ•°æ®å¿«ç…§

```sql
CREATE TABLE social_metrics (
    id SERIAL PRIMARY KEY,
    project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,

    -- Twitteræ•°æ®
    twitter_followers INTEGER,
    twitter_engagement_rate DECIMAL(5,2),

    -- Telegramæ•°æ®
    telegram_members INTEGER,
    telegram_online_members INTEGER,
    telegram_message_frequency INTEGER,  -- æ¶ˆæ¯æ•°/å°æ—¶

    -- Discordæ•°æ®
    discord_members INTEGER,
    discord_online_members INTEGER,

    -- YouTubeæ•°æ®
    youtube_mentions INTEGER,  -- è¢«æåŠæ¬¡æ•°
    youtube_total_views INTEGER,

    -- GitHubæ•°æ®
    github_stars INTEGER,
    github_forks INTEGER,
    github_commits_last_week INTEGER,
    github_contributors INTEGER,

    -- å¿«ç…§æ—¶é—´
    snapshot_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_social_metrics_project ON social_metrics(project_id);
CREATE INDEX idx_social_metrics_time ON social_metrics(snapshot_time DESC);
CREATE INDEX idx_social_metrics_project_time ON social_metrics(project_id, snapshot_time DESC);
```

**å­—æ®µè¯´æ˜**:
- **Twitter**: ç²‰ä¸æ•°ã€äº’åŠ¨ç‡
- **Telegram**: æˆå‘˜æ•°ã€åœ¨çº¿äººæ•°ã€æ¶ˆæ¯é¢‘ç‡
- **Discord**: æˆå‘˜æ•°ã€åœ¨çº¿äººæ•°
- **YouTube**: æåŠæ¬¡æ•°ã€æ€»è§‚çœ‹é‡
- **GitHub**: æ˜Ÿæ ‡ã€åˆ†å‰ã€æäº¤æ•°ã€è´¡çŒ®è€…

**æ•°æ®æ›´æ–°é¢‘ç‡**: æ¯1å°æ—¶

**å®ç°çŠ¶æ€**: âœ… å®Œæˆ

---

### 4. onchain_metrics (é“¾ä¸Šæ•°æ®æŒ‡æ ‡)

**ç”¨é€”**: å­˜å‚¨é¡¹ç›®çš„é“¾ä¸Šæ•°æ®å¿«ç…§

```sql
CREATE TABLE onchain_metrics (
    id SERIAL PRIMARY KEY,
    project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,

    -- åŸºç¡€æ•°æ®
    market_cap DECIMAL(20,2),
    total_supply DECIMAL(30,2),
    circulating_supply DECIMAL(30,2),
    price_usd DECIMAL(20,8),

    -- æµåŠ¨æ€§æ•°æ®
    liquidity_usd DECIMAL(20,2),
    volume_24h DECIMAL(20,2),

    -- æŒæœ‰è€…æ•°æ®
    holder_count INTEGER,
    top_10_holders_percentage DECIMAL(5,2),

    -- äº¤æ˜“æ•°æ®
    transaction_count_24h INTEGER,
    unique_wallets_24h INTEGER,

    -- TVL (for DeFi)
    tvl_usd DECIMAL(20,2),

    -- å¿«ç…§æ—¶é—´
    snapshot_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_onchain_metrics_project ON onchain_metrics(project_id);
CREATE INDEX idx_onchain_metrics_time ON onchain_metrics(snapshot_time DESC);
CREATE INDEX idx_onchain_metrics_project_time ON onchain_metrics(project_id, snapshot_time DESC);
```

**å­—æ®µè¯´æ˜**:
- **åŸºç¡€æ•°æ®**: å¸‚å€¼ã€ä¾›åº”é‡ã€ä»·æ ¼
- **æµåŠ¨æ€§**: æµåŠ¨æ€§æ± è§„æ¨¡ã€24å°æ—¶äº¤æ˜“é‡
- **æŒæœ‰è€…**: æŒæœ‰è€…æ•°é‡ã€å·¨é²¸å æ¯”
- **äº¤æ˜“**: 24å°æ—¶äº¤æ˜“æ•°ã€ç‹¬ç«‹é’±åŒ…æ•°
- **DeFiç‰¹å®š**: TVL (æ€»é”ä»“ä»·å€¼)

**æ•°æ®æ›´æ–°é¢‘ç‡**: æ¯10åˆ†é’Ÿ

**å®ç°çŠ¶æ€**: âœ… å®Œæˆ

---

### 5. ai_analysis (AIåˆ†æç»“æœ)

**ç”¨é€”**: å­˜å‚¨AIå¯¹é¡¹ç›®çš„åˆ†æç»“æœ

```sql
CREATE TABLE ai_analysis (
    id SERIAL PRIMARY KEY,
    project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,

    -- æ–‡æœ¬åˆ†æ
    whitepaper_summary TEXT,
    key_features JSON,  -- ["ç‰¹æ€§1", "ç‰¹æ€§2", "ç‰¹æ€§3"]
    similar_projects JSON,  -- [{"name": "Solana", "similarity": 0.85}, ...]

    -- æƒ…æ„Ÿåˆ†æ
    sentiment_score DECIMAL(5,2),  -- -1 åˆ° 1
    sentiment_label VARCHAR(20),  -- positive, neutral, negative

    -- é£é™©è¯†åˆ«
    risk_flags JSON,  -- [{"type": "team_anonymous", "severity": "medium"}, ...]
    scam_probability DECIMAL(5,2),  -- 0-100

    -- æŠ•èµ„å»ºè®®
    investment_suggestion TEXT,
    position_size VARCHAR(50),  -- "1-3%", "3-5%", "5-10%"
    entry_timing VARCHAR(100),  -- "ç«‹å³å°ä»“ä½åŸ‹ä¼", "ä¸»ç½‘ä¸Šçº¿å‰"
    stop_loss_percentage DECIMAL(5,2),

    -- åˆ†ææ—¶é—´
    analyzed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_ai_analysis_project ON ai_analysis(project_id);
CREATE INDEX idx_ai_analysis_time ON ai_analysis(analyzed_at DESC);
```

**å­—æ®µè¯´æ˜**:
- **æ–‡æœ¬åˆ†æ**: ç™½çš®ä¹¦æ‘˜è¦ã€æ ¸å¿ƒç‰¹æ€§ã€ç›¸ä¼¼é¡¹ç›®
- **æƒ…æ„Ÿåˆ†æ**: æƒ…æ„Ÿåˆ†æ•°ã€æƒ…æ„Ÿæ ‡ç­¾
- **é£é™©è¯†åˆ«**: é£é™©æ ‡è®°ã€è¯ˆéª—æ¦‚ç‡
- **æŠ•èµ„å»ºè®®**: å»ºä»“å»ºè®®ã€ä»“ä½å¤§å°ã€å…¥åœºæ—¶æœºã€æ­¢æŸç‚¹

**å®ç°çŠ¶æ€**: âœ… å®Œæˆ

---

### 6. ai_config (AIé…ç½®è¡¨)

**ç”¨é€”**: å­˜å‚¨AIæœåŠ¡çš„é…ç½®ä¿¡æ¯

```sql
CREATE TABLE ai_config (
    id VARCHAR PRIMARY KEY,  -- ä½¿ç”¨UUIDæˆ–è‡ªå®šä¹‰ID
    name VARCHAR NOT NULL,
    provider VARCHAR(50) NOT NULL,  -- 'openai', 'anthropic', 'deepseek'
    api_key TEXT NOT NULL,  -- åŠ å¯†å­˜å‚¨
    model VARCHAR(100) NOT NULL,
    enabled BOOLEAN DEFAULT false,
    parameters JSON,  -- {"temperature": 0.7, "max_tokens": 2000}
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_ai_config_provider ON ai_config(provider);
CREATE INDEX idx_ai_config_enabled ON ai_config(enabled);
```

**å­—æ®µè¯´æ˜**:
- `provider`: AIæœåŠ¡æä¾›å•† (openai/anthropic/deepseek)
- `api_key`: APIå¯†é’¥ (åŠ å¯†å­˜å‚¨)
- `model`: æ¨¡å‹åç§° (gpt-4/claude-3/deepseek-chat)
- `enabled`: æ˜¯å¦å¯ç”¨
- `parameters`: æ¨¡å‹å‚æ•° (temperature/max_tokensç­‰)

**å®ç°çŠ¶æ€**: âœ… å®Œæˆ

---

## ğŸš§ å¼€å‘ä¸­çš„è¡¨

### 7. daily_reports (æ¯æ—¥æŠ¥å‘Š) - è®¡åˆ’ä¸­

```sql
CREATE TABLE daily_reports (
    id SERIAL PRIMARY KEY,
    report_date DATE UNIQUE NOT NULL,

    -- ç»Ÿè®¡æ•°æ®
    total_projects_scanned INTEGER,
    new_projects_found INTEGER,
    s_grade_count INTEGER,
    a_grade_count INTEGER,
    b_grade_count INTEGER,

    -- æŠ¥å‘Šå†…å®¹
    report_content TEXT,  -- Markdownæ ¼å¼
    report_summary TEXT,

    -- æ¨é€çŠ¶æ€
    email_sent BOOLEAN DEFAULT FALSE,
    telegram_sent BOOLEAN DEFAULT FALSE,

    -- æ—¶é—´æˆ³
    generated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    published_at TIMESTAMP
);

CREATE INDEX idx_daily_reports_date ON daily_reports(report_date DESC);
```

---

### 8. user_watchlist (ç”¨æˆ·å…³æ³¨åˆ—è¡¨) - è®¡åˆ’ä¸­

```sql
CREATE TABLE user_watchlist (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,

    -- æé†’è®¾ç½®
    alert_price_change BOOLEAN DEFAULT true,
    alert_community_growth BOOLEAN DEFAULT true,
    alert_major_events BOOLEAN DEFAULT true,

    -- è‡ªå®šä¹‰å¤‡æ³¨
    user_note TEXT,

    -- æ—¶é—´æˆ³
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(user_id, project_id)
);

CREATE INDEX idx_watchlist_user ON user_watchlist(user_id);
CREATE INDEX idx_watchlist_project ON user_watchlist(project_id);
```

---

## ğŸ“ æ•°æ®åº“è¿ç§»è®°å½•

### Alembicè¿ç§»å†å²

#### Migration 001: åˆå§‹Schema (æœªè®°å½•)
- åˆ›å»ºåŸºç¡€è¡¨ç»“æ„
- åˆ›å»ºusersè¡¨
- åˆ›å»ºprojectsè¡¨
- åˆ›å»ºsocial_metricsè¡¨
- åˆ›å»ºonchain_metricsè¡¨
- åˆ›å»ºai_analysisè¡¨

#### Migration 002: AIé…ç½®è¡¨ (2025-01-08)
```python
"""add ai_config table

Revision ID: 002
Revises: 001
Create Date: 2025-01-08 12:00:00
"""

def upgrade():
    op.create_table(
        'ai_configs',
        sa.Column('id', sa.String(), nullable=False),
        sa.Column('name', sa.String(), nullable=False),
        sa.Column('api_key', sa.Text(), nullable=False),
        sa.Column('enabled', sa.Boolean(), default=False),
        sa.Column('model', sa.String(), nullable=False),
        sa.Column('created_at', sa.DateTime(timezone=True)),
        sa.Column('updated_at', sa.DateTime(timezone=True)),
        sa.PrimaryKeyConstraint('id')
    )
```

**è¿ç§»æ–‡ä»¶ä½ç½®**: `backend/alembic/versions/002_add_ai_config.py`

---

## ğŸ” ç´¢å¼•è®¾è®¡

### ä¸»è¦ç´¢å¼•

| è¡¨å | ç´¢å¼•å | å­—æ®µ | ç±»å‹ | ç”¨é€” |
|------|--------|------|------|------|
| users | idx_users_username | username | B-tree | ç™»å½•æŸ¥è¯¢ |
| users | idx_users_email | email | B-tree | é‚®ç®±æŸ¥æ‰¾ |
| projects | idx_projects_score | overall_score DESC | B-tree | è¯„åˆ†æ’åº |
| projects | idx_projects_score_grade | (overall_score, grade) | å¤åˆ | è¯„åˆ†+è¯„çº§æŸ¥è¯¢ |
| projects | idx_projects_category | category | B-tree | åˆ†ç±»ç­›é€‰ |
| social_metrics | idx_social_metrics_project_time | (project_id, snapshot_time) | å¤åˆ | æ—¶åºæŸ¥è¯¢ |
| onchain_metrics | idx_onchain_metrics_project_time | (project_id, snapshot_time) | å¤åˆ | æ—¶åºæŸ¥è¯¢ |

### ç´¢å¼•ä¼˜åŒ–å»ºè®®

#### 1. å¤åˆç´¢å¼•ä¼˜åŒ–
```sql
-- ä¼˜åŒ–é¡¹ç›®åˆ—è¡¨æŸ¥è¯¢ (è¯„çº§ + è¯„åˆ†æ’åº)
CREATE INDEX idx_projects_grade_score ON projects(grade, overall_score DESC);

-- ä¼˜åŒ–åˆ†ç±» + åŒºå—é“¾ç­›é€‰
CREATE INDEX idx_projects_category_blockchain ON projects(category, blockchain);
```

#### 2. éƒ¨åˆ†ç´¢å¼• (Partial Index)
```sql
-- åªç´¢å¼•æ´»è·ƒé¡¹ç›®
CREATE INDEX idx_projects_active ON projects(overall_score DESC)
WHERE status = 'published';

-- åªç´¢å¼•é«˜è¯„åˆ†é¡¹ç›®
CREATE INDEX idx_projects_high_score ON projects(overall_score DESC)
WHERE overall_score >= 80;
```

#### 3. è¡¨è¾¾å¼ç´¢å¼•
```sql
-- é¡¹ç›®åç§°å°å†™æœç´¢
CREATE INDEX idx_projects_name_lower ON projects(LOWER(project_name));
```

---

## ğŸ—ºï¸ æ•°æ®å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   users     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1:N (planned)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_watchlist  â”‚â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
                         â”‚ N:1
                         â”‚
                         â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    projects      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              â”‚              â”‚            â”‚
        â”‚ 1:N          â”‚ 1:N          â”‚ 1:N        â”‚ 1:N
        â–¼              â–¼              â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚social_metricsâ”‚ â”‚onchain_metricsâ”‚ â”‚ai_analysisâ”‚ â”‚daily_reports â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                (planned)
```

---

## âš¡ æŸ¥è¯¢ä¼˜åŒ–

### å¸¸ç”¨æŸ¥è¯¢æ¨¡å¼

#### 1. é¡¹ç›®åˆ—è¡¨æŸ¥è¯¢ (å¸¦ç­›é€‰å’Œåˆ†é¡µ)
```sql
-- ä¼˜åŒ–å‰
SELECT * FROM projects
WHERE grade = 'S'
  AND category = 'DeFi'
ORDER BY overall_score DESC
LIMIT 20 OFFSET 0;

-- ä¼˜åŒ–å»ºè®®: ä½¿ç”¨å¤åˆç´¢å¼•
-- CREATE INDEX idx_projects_grade_category_score
-- ON projects(grade, category, overall_score DESC);
```

**Explainç»“æœ**:
```
Index Scan using idx_projects_grade_category_score on projects
  Filter: (grade = 'S' AND category = 'DeFi')
  Limit: 20
```

#### 2. é¡¹ç›®å†å²æ•°æ®æŸ¥è¯¢
```sql
-- æŸ¥è¯¢é¡¹ç›®è¿‘7å¤©çš„ç¤¾äº¤æ•°æ®
SELECT
    sm.snapshot_time,
    sm.twitter_followers,
    sm.telegram_members
FROM social_metrics sm
WHERE sm.project_id = 123
  AND sm.snapshot_time >= NOW() - INTERVAL '7 days'
ORDER BY sm.snapshot_time DESC;

-- ä½¿ç”¨ç´¢å¼•: idx_social_metrics_project_time
```

#### 3. Topé¡¹ç›®æ’è¡Œæ¦œ
```sql
-- ä½¿ç”¨ç‰©åŒ–è§†å›¾åŠ é€Ÿ
CREATE MATERIALIZED VIEW mv_top_projects AS
SELECT
    p.id,
    p.project_name,
    p.overall_score,
    p.grade,
    p.category
FROM projects p
WHERE p.status = 'published'
ORDER BY p.overall_score DESC
LIMIT 100;

-- æ¯å°æ—¶åˆ·æ–°
REFRESH MATERIALIZED VIEW mv_top_projects;
```

### æ…¢æŸ¥è¯¢ä¼˜åŒ–æ¡ˆä¾‹

#### æ¡ˆä¾‹1: è”è¡¨æŸ¥è¯¢ä¼˜åŒ–
```sql
-- æ…¢æŸ¥è¯¢ (N+1é—®é¢˜)
-- å…ˆæŸ¥é¡¹ç›®,å†é€ä¸ªæŸ¥ç¤¾äº¤æ•°æ®
SELECT * FROM projects WHERE grade = 'S';
-- ç„¶ååœ¨åº”ç”¨å±‚å¾ªç¯: SELECT * FROM social_metrics WHERE project_id = ?

-- ä¼˜åŒ–: ä½¿ç”¨JOIN
SELECT
    p.*,
    sm.twitter_followers,
    sm.telegram_members,
    om.market_cap,
    om.tvl_usd
FROM projects p
LEFT JOIN LATERAL (
    SELECT * FROM social_metrics
    WHERE project_id = p.id
    ORDER BY snapshot_time DESC
    LIMIT 1
) sm ON true
LEFT JOIN LATERAL (
    SELECT * FROM onchain_metrics
    WHERE project_id = p.id
    ORDER BY snapshot_time DESC
    LIMIT 1
) om ON true
WHERE p.grade = 'S';
```

#### æ¡ˆä¾‹2: ç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ–
```sql
-- ä½¿ç”¨èšåˆè¡¨
CREATE TABLE project_stats (
    project_id INTEGER PRIMARY KEY,
    latest_twitter_followers INTEGER,
    latest_market_cap DECIMAL(20,2),
    avg_score_7d DECIMAL(5,2),
    updated_at TIMESTAMP
);

-- å®šæ—¶æ›´æ–° (Celeryä»»åŠ¡)
INSERT INTO project_stats
SELECT
    p.id,
    (SELECT twitter_followers FROM social_metrics
     WHERE project_id = p.id
     ORDER BY snapshot_time DESC LIMIT 1),
    (SELECT market_cap FROM onchain_metrics
     WHERE project_id = p.id
     ORDER BY snapshot_time DESC LIMIT 1),
    p.overall_score,
    NOW()
FROM projects p
ON CONFLICT (project_id) DO UPDATE
SET
    latest_twitter_followers = EXCLUDED.latest_twitter_followers,
    latest_market_cap = EXCLUDED.latest_market_cap,
    updated_at = EXCLUDED.updated_at;
```

---

## ğŸ” æ•°æ®å®‰å…¨

### æ•æ„Ÿæ•°æ®åŠ å¯†

#### 1. APIå¯†é’¥åŠ å¯†å­˜å‚¨
```python
from cryptography.fernet import Fernet

# ç”Ÿæˆå¯†é’¥ (å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡)
ENCRYPTION_KEY = os.getenv("ENCRYPTION_KEY")
cipher = Fernet(ENCRYPTION_KEY)

# åŠ å¯†
def encrypt_api_key(api_key: str) -> str:
    return cipher.encrypt(api_key.encode()).decode()

# è§£å¯†
def decrypt_api_key(encrypted_key: str) -> str:
    return cipher.decrypt(encrypted_key.encode()).decode()
```

#### 2. å¯†ç å“ˆå¸Œ
```python
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# å“ˆå¸Œå¯†ç 
hashed = pwd_context.hash("user_password")

# éªŒè¯å¯†ç 
is_valid = pwd_context.verify("user_password", hashed)
```

### æ•°æ®å¤‡ä»½ç­–ç•¥

#### 1. è‡ªåŠ¨å¤‡ä»½ (PostgreSQL)
```bash
# æ¯æ—¥å…¨é‡å¤‡ä»½
pg_dump -h localhost -U postgres web3_alpha_hunter > backup_$(date +%Y%m%d).sql

# å‹ç¼©
gzip backup_$(date +%Y%m%d).sql
```

#### 2. æ—¶é—´ç‚¹æ¢å¤ (PITR)
```bash
# å¯ç”¨WALå½’æ¡£
archive_mode = on
archive_command = 'cp %p /var/lib/postgresql/wal_archive/%f'
```

---

## ğŸ“Š æ•°æ®åº“ç›‘æ§

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | é˜ˆå€¼ | ç›‘æ§å·¥å…· |
|------|------|----------|
| è¿æ¥æ•° | < 80% max_connections | pg_stat_activity |
| æ…¢æŸ¥è¯¢ | > 1s | pg_stat_statements |
| ç¼“å­˜å‘½ä¸­ç‡ | > 95% | pg_stat_database |
| è¡¨è†¨èƒ€ | < 20% | pg_stat_user_tables |
| ç´¢å¼•ä½¿ç”¨ç‡ | > 80% | pg_stat_user_indexes |

### ç›‘æ§æŸ¥è¯¢

```sql
-- 1. æŸ¥çœ‹å½“å‰è¿æ¥æ•°
SELECT count(*) FROM pg_stat_activity;

-- 2. æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 3. æŸ¥çœ‹ç¼“å­˜å‘½ä¸­ç‡
SELECT
    datname,
    blks_hit::float/(blks_hit + blks_read) as cache_hit_ratio
FROM pg_stat_database
WHERE datname = 'web3_alpha_hunter';

-- 4. æŸ¥çœ‹æœªä½¿ç”¨çš„ç´¢å¼•
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan
FROM pg_stat_user_indexes
WHERE idx_scan = 0
  AND indexname NOT LIKE 'pg_toast%';
```

---

## ğŸ”„ æœªæ¥æ‰©å±•

### è®¡åˆ’ä¸­çš„è¡¨

#### 1. alerts (æŠ¥è­¦è®°å½•)
```sql
CREATE TABLE alerts (
    id SERIAL PRIMARY KEY,
    project_id INTEGER REFERENCES projects(id),
    alert_type VARCHAR(50),  -- price_spike, whale_activity, community_surge
    severity VARCHAR(20),  -- low, medium, high, critical
    message TEXT,
    metadata JSON,
    triggered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2. user_notifications (ç”¨æˆ·é€šçŸ¥)
```sql
CREATE TABLE user_notifications (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    notification_type VARCHAR(50),
    title VARCHAR(255),
    content TEXT,
    is_read BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3. api_usage_logs (APIä½¿ç”¨æ—¥å¿—)
```sql
CREATE TABLE api_usage_logs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    endpoint VARCHAR(255),
    method VARCHAR(10),
    status_code INTEGER,
    response_time_ms INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ä½¿ç”¨TimescaleDBä¼˜åŒ–æ—¶åºæ•°æ®
SELECT create_hypertable('api_usage_logs', 'created_at');
```

---

## ğŸ“š å‚è€ƒèµ„æº

- [PostgreSQLå®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/)
- [SQLAlchemyæ–‡æ¡£](https://docs.sqlalchemy.org/)
- [Alembicæ–‡æ¡£](https://alembic.sqlalchemy.org/)
- [æ•°æ®åº“è®¾è®¡æœ€ä½³å®è·µ](https://www.postgresql.org/docs/current/performance-tips.html)

---

**ç»´æŠ¤è¯´æ˜**:
- æ¯æ¬¡æ•°æ®åº“ç»“æ„å˜æ›´åæ›´æ–°æ­¤æ–‡æ¡£
- è®°å½•è¿ç§»æ–‡ä»¶å’Œç‰ˆæœ¬å·
- æ›´æ–°ç´¢å¼•ä¼˜åŒ–å»ºè®®
- å®šæœŸå®¡æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—
