# 数据库设计文档

> **最后更新**: 2025-10-04
> **文档版本**: v1.0
> **数据库**: PostgreSQL 15+

---

## 📋 目录

1. [概览](#概览)
2. [已实现的表结构](#已实现的表结构)
3. [数据库迁移记录](#数据库迁移记录)
4. [索引设计](#索引设计)
5. [数据关系图](#数据关系图)
6. [查询优化](#查询优化)

---

## 📊 概览

### 技术栈
- **数据库**: PostgreSQL 15+
- **ORM**: SQLAlchemy 2.0
- **迁移工具**: Alembic
- **连接池**: SQLAlchemy Pool (pool_size=20)

### 当前状态
- ✅ **已实现的表**: 6个
- 🚧 **开发中的表**: 2个
- 📋 **计划中的表**: 3个

---

## ✅ 已实现的表结构

### 1. users (用户表)

**用途**: 存储用户认证信息和角色权限

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    hashed_password VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    role VARCHAR(20) DEFAULT 'user',  -- 'admin' 或 'user'
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
```

**字段说明**:
- `id`: 主键,自增
- `username`: 用户名,唯一
- `email`: 邮箱,唯一
- `hashed_password`: bcrypt加密的密码
- `role`: 角色 (admin/user)
- `is_active`: 账户是否激活

**实现状态**: ✅ 完成

---

### 2. projects (项目主表)

**用途**: 存储Web3项目的基础信息和评分

```sql
CREATE TABLE projects (
    -- 主键
    id SERIAL PRIMARY KEY,

    -- 基础信息
    project_name VARCHAR(255) NOT NULL,
    symbol VARCHAR(50),
    contract_address VARCHAR(255) UNIQUE,
    blockchain VARCHAR(50),
    category VARCHAR(100),  -- DeFi, NFT, GameFi, Infrastructure

    -- 描述信息
    description TEXT,
    website VARCHAR(500),
    whitepaper_url VARCHAR(500),
    twitter_handle VARCHAR(100),
    telegram_channel VARCHAR(100),
    discord_link VARCHAR(500),
    github_repo VARCHAR(500),
    logo_url VARCHAR(500),

    -- 评分相关 (0-100)
    overall_score DECIMAL(5,2),
    team_score DECIMAL(5,2),
    tech_score DECIMAL(5,2),
    community_score DECIMAL(5,2),
    tokenomics_score DECIMAL(5,2),
    market_timing_score DECIMAL(5,2),
    risk_score DECIMAL(5,2),

    grade VARCHAR(1),  -- S, A, B, C

    -- 状态
    status VARCHAR(50) DEFAULT 'discovered',  -- discovered, analyzing, published, archived
    first_discovered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- 元数据
    discovered_from VARCHAR(100),  -- twitter, telegram, youtube, coingecko
    extra_metadata JSON,  -- 额外的灵活数据

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_projects_name ON projects(project_name);
CREATE INDEX idx_projects_score ON projects(overall_score DESC);
CREATE INDEX idx_projects_grade ON projects(grade);
CREATE INDEX idx_projects_blockchain ON projects(blockchain);
CREATE INDEX idx_projects_category ON projects(category);
CREATE INDEX idx_projects_discovered_at ON projects(first_discovered_at DESC);
CREATE INDEX idx_projects_score_grade ON projects(overall_score DESC, grade);
```

**字段说明**:
- **基础信息**: 项目名称、代币符号、合约地址、区块链、分类
- **社交链接**: Twitter、Telegram、Discord、GitHub等
- **评分体系**: 6维度评分 + 综合评分 + 评级
- **状态管理**: 发现状态、发现时间、更新时间
- **元数据**: JSON格式存储灵活数据

**实现状态**: ✅ 完成

---

### 3. social_metrics (社交媒体指标)

**用途**: 存储项目的社交媒体数据快照

```sql
CREATE TABLE social_metrics (
    id SERIAL PRIMARY KEY,
    project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,

    -- Twitter数据
    twitter_followers INTEGER,
    twitter_engagement_rate DECIMAL(5,2),

    -- Telegram数据
    telegram_members INTEGER,
    telegram_online_members INTEGER,
    telegram_message_frequency INTEGER,  -- 消息数/小时

    -- Discord数据
    discord_members INTEGER,
    discord_online_members INTEGER,

    -- YouTube数据
    youtube_mentions INTEGER,  -- 被提及次数
    youtube_total_views INTEGER,

    -- GitHub数据
    github_stars INTEGER,
    github_forks INTEGER,
    github_commits_last_week INTEGER,
    github_contributors INTEGER,

    -- 快照时间
    snapshot_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_social_metrics_project ON social_metrics(project_id);
CREATE INDEX idx_social_metrics_time ON social_metrics(snapshot_time DESC);
CREATE INDEX idx_social_metrics_project_time ON social_metrics(project_id, snapshot_time DESC);
```

**字段说明**:
- **Twitter**: 粉丝数、互动率
- **Telegram**: 成员数、在线人数、消息频率
- **Discord**: 成员数、在线人数
- **YouTube**: 提及次数、总观看量
- **GitHub**: 星标、分叉、提交数、贡献者

**数据更新频率**: 每1小时

**实现状态**: ✅ 完成

---

### 4. onchain_metrics (链上数据指标)

**用途**: 存储项目的链上数据快照

```sql
CREATE TABLE onchain_metrics (
    id SERIAL PRIMARY KEY,
    project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,

    -- 基础数据
    market_cap DECIMAL(20,2),
    total_supply DECIMAL(30,2),
    circulating_supply DECIMAL(30,2),
    price_usd DECIMAL(20,8),

    -- 流动性数据
    liquidity_usd DECIMAL(20,2),
    volume_24h DECIMAL(20,2),

    -- 持有者数据
    holder_count INTEGER,
    top_10_holders_percentage DECIMAL(5,2),

    -- 交易数据
    transaction_count_24h INTEGER,
    unique_wallets_24h INTEGER,

    -- TVL (for DeFi)
    tvl_usd DECIMAL(20,2),

    -- 快照时间
    snapshot_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_onchain_metrics_project ON onchain_metrics(project_id);
CREATE INDEX idx_onchain_metrics_time ON onchain_metrics(snapshot_time DESC);
CREATE INDEX idx_onchain_metrics_project_time ON onchain_metrics(project_id, snapshot_time DESC);
```

**字段说明**:
- **基础数据**: 市值、供应量、价格
- **流动性**: 流动性池规模、24小时交易量
- **持有者**: 持有者数量、巨鲸占比
- **交易**: 24小时交易数、独立钱包数
- **DeFi特定**: TVL (总锁仓价值)

**数据更新频率**: 每10分钟

**实现状态**: ✅ 完成

---

### 5. ai_analysis (AI分析结果)

**用途**: 存储AI对项目的分析结果

```sql
CREATE TABLE ai_analysis (
    id SERIAL PRIMARY KEY,
    project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,

    -- 文本分析
    whitepaper_summary TEXT,
    key_features JSON,  -- ["特性1", "特性2", "特性3"]
    similar_projects JSON,  -- [{"name": "Solana", "similarity": 0.85}, ...]

    -- 情感分析
    sentiment_score DECIMAL(5,2),  -- -1 到 1
    sentiment_label VARCHAR(20),  -- positive, neutral, negative

    -- 风险识别
    risk_flags JSON,  -- [{"type": "team_anonymous", "severity": "medium"}, ...]
    scam_probability DECIMAL(5,2),  -- 0-100

    -- 投资建议
    investment_suggestion TEXT,
    position_size VARCHAR(50),  -- "1-3%", "3-5%", "5-10%"
    entry_timing VARCHAR(100),  -- "立即小仓位埋伏", "主网上线前"
    stop_loss_percentage DECIMAL(5,2),

    -- 分析时间
    analyzed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_ai_analysis_project ON ai_analysis(project_id);
CREATE INDEX idx_ai_analysis_time ON ai_analysis(analyzed_at DESC);
```

**字段说明**:
- **文本分析**: 白皮书摘要、核心特性、相似项目
- **情感分析**: 情感分数、情感标签
- **风险识别**: 风险标记、诈骗概率
- **投资建议**: 建仓建议、仓位大小、入场时机、止损点

**实现状态**: ✅ 完成

---

### 6. ai_config (AI配置表)

**用途**: 存储AI服务的配置信息

```sql
CREATE TABLE ai_config (
    id VARCHAR PRIMARY KEY,  -- 使用UUID或自定义ID
    name VARCHAR NOT NULL,
    provider VARCHAR(50) NOT NULL,  -- 'openai', 'anthropic', 'deepseek'
    api_key TEXT NOT NULL,  -- 加密存储
    model VARCHAR(100) NOT NULL,
    enabled BOOLEAN DEFAULT false,
    parameters JSON,  -- {"temperature": 0.7, "max_tokens": 2000}
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_ai_config_provider ON ai_config(provider);
CREATE INDEX idx_ai_config_enabled ON ai_config(enabled);
```

**字段说明**:
- `provider`: AI服务提供商 (openai/anthropic/deepseek)
- `api_key`: API密钥 (加密存储)
- `model`: 模型名称 (gpt-4/claude-3/deepseek-chat)
- `enabled`: 是否启用
- `parameters`: 模型参数 (temperature/max_tokens等)

**实现状态**: ✅ 完成

---

## 🚧 开发中的表

### 7. daily_reports (每日报告) - 计划中

```sql
CREATE TABLE daily_reports (
    id SERIAL PRIMARY KEY,
    report_date DATE UNIQUE NOT NULL,

    -- 统计数据
    total_projects_scanned INTEGER,
    new_projects_found INTEGER,
    s_grade_count INTEGER,
    a_grade_count INTEGER,
    b_grade_count INTEGER,

    -- 报告内容
    report_content TEXT,  -- Markdown格式
    report_summary TEXT,

    -- 推送状态
    email_sent BOOLEAN DEFAULT FALSE,
    telegram_sent BOOLEAN DEFAULT FALSE,

    -- 时间戳
    generated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    published_at TIMESTAMP
);

CREATE INDEX idx_daily_reports_date ON daily_reports(report_date DESC);
```

---

### 8. user_watchlist (用户关注列表) - 计划中

```sql
CREATE TABLE user_watchlist (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,

    -- 提醒设置
    alert_price_change BOOLEAN DEFAULT true,
    alert_community_growth BOOLEAN DEFAULT true,
    alert_major_events BOOLEAN DEFAULT true,

    -- 自定义备注
    user_note TEXT,

    -- 时间戳
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(user_id, project_id)
);

CREATE INDEX idx_watchlist_user ON user_watchlist(user_id);
CREATE INDEX idx_watchlist_project ON user_watchlist(project_id);
```

---

## 📝 数据库迁移记录

### Alembic迁移历史

#### Migration 001: 初始Schema (未记录)
- 创建基础表结构
- 创建users表
- 创建projects表
- 创建social_metrics表
- 创建onchain_metrics表
- 创建ai_analysis表

#### Migration 002: AI配置表 (2025-01-08)
```python
"""add ai_config table

Revision ID: 002
Revises: 001
Create Date: 2025-01-08 12:00:00
"""

def upgrade():
    op.create_table(
        'ai_configs',
        sa.Column('id', sa.String(), nullable=False),
        sa.Column('name', sa.String(), nullable=False),
        sa.Column('api_key', sa.Text(), nullable=False),
        sa.Column('enabled', sa.Boolean(), default=False),
        sa.Column('model', sa.String(), nullable=False),
        sa.Column('created_at', sa.DateTime(timezone=True)),
        sa.Column('updated_at', sa.DateTime(timezone=True)),
        sa.PrimaryKeyConstraint('id')
    )
```

**迁移文件位置**: `backend/alembic/versions/002_add_ai_config.py`

---

## 🔍 索引设计

### 主要索引

| 表名 | 索引名 | 字段 | 类型 | 用途 |
|------|--------|------|------|------|
| users | idx_users_username | username | B-tree | 登录查询 |
| users | idx_users_email | email | B-tree | 邮箱查找 |
| projects | idx_projects_score | overall_score DESC | B-tree | 评分排序 |
| projects | idx_projects_score_grade | (overall_score, grade) | 复合 | 评分+评级查询 |
| projects | idx_projects_category | category | B-tree | 分类筛选 |
| social_metrics | idx_social_metrics_project_time | (project_id, snapshot_time) | 复合 | 时序查询 |
| onchain_metrics | idx_onchain_metrics_project_time | (project_id, snapshot_time) | 复合 | 时序查询 |

### 索引优化建议

#### 1. 复合索引优化
```sql
-- 优化项目列表查询 (评级 + 评分排序)
CREATE INDEX idx_projects_grade_score ON projects(grade, overall_score DESC);

-- 优化分类 + 区块链筛选
CREATE INDEX idx_projects_category_blockchain ON projects(category, blockchain);
```

#### 2. 部分索引 (Partial Index)
```sql
-- 只索引活跃项目
CREATE INDEX idx_projects_active ON projects(overall_score DESC)
WHERE status = 'published';

-- 只索引高评分项目
CREATE INDEX idx_projects_high_score ON projects(overall_score DESC)
WHERE overall_score >= 80;
```

#### 3. 表达式索引
```sql
-- 项目名称小写搜索
CREATE INDEX idx_projects_name_lower ON projects(LOWER(project_name));
```

---

## 🗺️ 数据关系图

```
┌─────────────┐
│   users     │
└──────┬──────┘
       │
       │ 1:N (planned)
       │
       ▼
┌─────────────────┐
│ user_watchlist  │──────┐
└─────────────────┘      │
                         │ N:1
                         │
                         ▼
              ┌──────────────────┐
              │    projects      │
              └────────┬─────────┘
                       │
        ┌──────────────┼──────────────┬────────────┐
        │              │              │            │
        │ 1:N          │ 1:N          │ 1:N        │ 1:N
        ▼              ▼              ▼            ▼
┌──────────────┐ ┌──────────────┐ ┌──────────┐ ┌──────────────┐
│social_metrics│ │onchain_metrics│ │ai_analysis│ │daily_reports │
└──────────────┘ └──────────────┘ └──────────┘ └──────────────┘
                                                (planned)
```

---

## ⚡ 查询优化

### 常用查询模式

#### 1. 项目列表查询 (带筛选和分页)
```sql
-- 优化前
SELECT * FROM projects
WHERE grade = 'S'
  AND category = 'DeFi'
ORDER BY overall_score DESC
LIMIT 20 OFFSET 0;

-- 优化建议: 使用复合索引
-- CREATE INDEX idx_projects_grade_category_score
-- ON projects(grade, category, overall_score DESC);
```

**Explain结果**:
```
Index Scan using idx_projects_grade_category_score on projects
  Filter: (grade = 'S' AND category = 'DeFi')
  Limit: 20
```

#### 2. 项目历史数据查询
```sql
-- 查询项目近7天的社交数据
SELECT
    sm.snapshot_time,
    sm.twitter_followers,
    sm.telegram_members
FROM social_metrics sm
WHERE sm.project_id = 123
  AND sm.snapshot_time >= NOW() - INTERVAL '7 days'
ORDER BY sm.snapshot_time DESC;

-- 使用索引: idx_social_metrics_project_time
```

#### 3. Top项目排行榜
```sql
-- 使用物化视图加速
CREATE MATERIALIZED VIEW mv_top_projects AS
SELECT
    p.id,
    p.project_name,
    p.overall_score,
    p.grade,
    p.category
FROM projects p
WHERE p.status = 'published'
ORDER BY p.overall_score DESC
LIMIT 100;

-- 每小时刷新
REFRESH MATERIALIZED VIEW mv_top_projects;
```

### 慢查询优化案例

#### 案例1: 联表查询优化
```sql
-- 慢查询 (N+1问题)
-- 先查项目,再逐个查社交数据
SELECT * FROM projects WHERE grade = 'S';
-- 然后在应用层循环: SELECT * FROM social_metrics WHERE project_id = ?

-- 优化: 使用JOIN
SELECT
    p.*,
    sm.twitter_followers,
    sm.telegram_members,
    om.market_cap,
    om.tvl_usd
FROM projects p
LEFT JOIN LATERAL (
    SELECT * FROM social_metrics
    WHERE project_id = p.id
    ORDER BY snapshot_time DESC
    LIMIT 1
) sm ON true
LEFT JOIN LATERAL (
    SELECT * FROM onchain_metrics
    WHERE project_id = p.id
    ORDER BY snapshot_time DESC
    LIMIT 1
) om ON true
WHERE p.grade = 'S';
```

#### 案例2: 统计查询优化
```sql
-- 使用聚合表
CREATE TABLE project_stats (
    project_id INTEGER PRIMARY KEY,
    latest_twitter_followers INTEGER,
    latest_market_cap DECIMAL(20,2),
    avg_score_7d DECIMAL(5,2),
    updated_at TIMESTAMP
);

-- 定时更新 (Celery任务)
INSERT INTO project_stats
SELECT
    p.id,
    (SELECT twitter_followers FROM social_metrics
     WHERE project_id = p.id
     ORDER BY snapshot_time DESC LIMIT 1),
    (SELECT market_cap FROM onchain_metrics
     WHERE project_id = p.id
     ORDER BY snapshot_time DESC LIMIT 1),
    p.overall_score,
    NOW()
FROM projects p
ON CONFLICT (project_id) DO UPDATE
SET
    latest_twitter_followers = EXCLUDED.latest_twitter_followers,
    latest_market_cap = EXCLUDED.latest_market_cap,
    updated_at = EXCLUDED.updated_at;
```

---

## 🔐 数据安全

### 敏感数据加密

#### 1. API密钥加密存储
```python
from cryptography.fernet import Fernet

# 生成密钥 (存储在环境变量)
ENCRYPTION_KEY = os.getenv("ENCRYPTION_KEY")
cipher = Fernet(ENCRYPTION_KEY)

# 加密
def encrypt_api_key(api_key: str) -> str:
    return cipher.encrypt(api_key.encode()).decode()

# 解密
def decrypt_api_key(encrypted_key: str) -> str:
    return cipher.decrypt(encrypted_key.encode()).decode()
```

#### 2. 密码哈希
```python
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# 哈希密码
hashed = pwd_context.hash("user_password")

# 验证密码
is_valid = pwd_context.verify("user_password", hashed)
```

### 数据备份策略

#### 1. 自动备份 (PostgreSQL)
```bash
# 每日全量备份
pg_dump -h localhost -U postgres web3_alpha_hunter > backup_$(date +%Y%m%d).sql

# 压缩
gzip backup_$(date +%Y%m%d).sql
```

#### 2. 时间点恢复 (PITR)
```bash
# 启用WAL归档
archive_mode = on
archive_command = 'cp %p /var/lib/postgresql/wal_archive/%f'
```

---

## 📊 数据库监控

### 关键指标

| 指标 | 阈值 | 监控工具 |
|------|------|----------|
| 连接数 | < 80% max_connections | pg_stat_activity |
| 慢查询 | > 1s | pg_stat_statements |
| 缓存命中率 | > 95% | pg_stat_database |
| 表膨胀 | < 20% | pg_stat_user_tables |
| 索引使用率 | > 80% | pg_stat_user_indexes |

### 监控查询

```sql
-- 1. 查看当前连接数
SELECT count(*) FROM pg_stat_activity;

-- 2. 查看慢查询
SELECT
    query,
    calls,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 3. 查看缓存命中率
SELECT
    datname,
    blks_hit::float/(blks_hit + blks_read) as cache_hit_ratio
FROM pg_stat_database
WHERE datname = 'web3_alpha_hunter';

-- 4. 查看未使用的索引
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan
FROM pg_stat_user_indexes
WHERE idx_scan = 0
  AND indexname NOT LIKE 'pg_toast%';
```

---

## 🔄 未来扩展

### 计划中的表

#### 1. alerts (报警记录)
```sql
CREATE TABLE alerts (
    id SERIAL PRIMARY KEY,
    project_id INTEGER REFERENCES projects(id),
    alert_type VARCHAR(50),  -- price_spike, whale_activity, community_surge
    severity VARCHAR(20),  -- low, medium, high, critical
    message TEXT,
    metadata JSON,
    triggered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2. user_notifications (用户通知)
```sql
CREATE TABLE user_notifications (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    notification_type VARCHAR(50),
    title VARCHAR(255),
    content TEXT,
    is_read BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3. api_usage_logs (API使用日志)
```sql
CREATE TABLE api_usage_logs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    endpoint VARCHAR(255),
    method VARCHAR(10),
    status_code INTEGER,
    response_time_ms INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 使用TimescaleDB优化时序数据
SELECT create_hypertable('api_usage_logs', 'created_at');
```

---

## 📚 参考资源

- [PostgreSQL官方文档](https://www.postgresql.org/docs/)
- [SQLAlchemy文档](https://docs.sqlalchemy.org/)
- [Alembic文档](https://alembic.sqlalchemy.org/)
- [数据库设计最佳实践](https://www.postgresql.org/docs/current/performance-tips.html)

---

**维护说明**:
- 每次数据库结构变更后更新此文档
- 记录迁移文件和版本号
- 更新索引优化建议
- 定期审查慢查询日志
