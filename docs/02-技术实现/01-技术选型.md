# 技术选型文档

## 🎯 选型原则

1. **快速开发**: 优先选择成熟框架,减少重复造轮子
2. **可扩展性**: 支持从MVP到百万用户的平滑扩展
3. **成本控制**: 初期使用免费/低成本方案,按需升级
4. **社区活跃**: 优先选择生态丰富、文档完善的技术栈
5. **AI优先**: 深度集成AI能力,而非后期补充

---

## 🏗️ 整体架构

```
┌──────────────────────────────────────────────┐
│           前端展示层 (Next.js)                │
│  Web Dashboard + Landing Page                │
└──────────────────────────────────────────────┘
                    ↓ REST API / WebSocket
┌──────────────────────────────────────────────┐
│         后端服务层 (Python FastAPI)           │
│  API Gateway + Business Logic                │
└──────────────────────────────────────────────┘
         ↓                              ↓
┌─────────────────┐          ┌─────────────────┐
│  数据采集层       │          │   AI分析层       │
│  (Celery Task)  │          │  (LangChain)    │
└─────────────────┘          └─────────────────┘
         ↓                              ↓
┌──────────────────────────────────────────────┐
│          数据存储层                           │
│  PostgreSQL + Redis + S3                     │
└──────────────────────────────────────────────┘
```

---

## 💻 前端技术栈

### 核心框架

**Next.js 14 (App Router)** ✅

**选择理由**:
- ✅ React生态,组件丰富
- ✅ SSR/SSG支持,SEO友好
- ✅ API Routes内置,简化架构
- ✅ Vercel免费部署
- ✅ 图片/字体自动优化

**替代方案对比**:
| 方案 | 优势 | 劣势 | 评分 |
|------|------|------|------|
| Next.js | 全栈能力、部署简单 | 学习曲线 | ⭐⭐⭐⭐⭐ |
| Vite + React | 开发体验好、快 | 需要自己配置SSR | ⭐⭐⭐⭐ |
| Nuxt.js | Vue生态完善 | 社区相对小 | ⭐⭐⭐ |

---

### UI组件库

**Shadcn/ui + Tailwind CSS** ✅

**选择理由**:
- ✅ 无运行时,打包体积小
- ✅ 完全可定制
- ✅ 暗色模式原生支持
- ✅ 无障碍性好 (ARIA标签完善)
- ✅ 代码可复制,不依赖npm包

**组件列表**:
```bash
# 核心组件
- Button, Card, Badge
- Table, Dialog, Dropdown
- Tabs, Select, Input
- Toast, Alert, Skeleton
```

---

### 数据可视化

**Recharts** ✅

**选择理由**:
- ✅ React原生,API简洁
- ✅ 响应式设计
- ✅ 支持动画
- ✅ 定制性强

**图表类型**:
- Line Chart (趋势图)
- Radar Chart (评分雷达图)
- Bar Chart (对比图)
- Pie Chart (占比图)

---

### 状态管理

**Zustand** ✅

**选择理由**:
- ✅ 轻量级 (1KB)
- ✅ API简单,无模板代码
- ✅ TypeScript友好
- ✅ 支持中间件 (persist, devtools)

**示例**:
```typescript
// store/projectStore.ts
import create from 'zustand'

interface ProjectStore {
  projects: Project[]
  filters: Filters
  setFilters: (filters: Filters) => void
}

export const useProjectStore = create<ProjectStore>((set) => ({
  projects: [],
  filters: { grade: 'all', date: 'today' },
  setFilters: (filters) => set({ filters }),
}))
```

---

### 实时通信

**WebSocket (原生) + SWR** ✅

**选择理由**:
- ✅ Next.js原生支持WebSocket
- ✅ SWR自动数据同步
- ✅ 断线重连机制

**使用场景**:
- 新项目实时推送
- 价格异动通知
- 实时监控看板

---

## 🔧 后端技术栈

### 核心框架

**FastAPI (Python 3.11+)** ✅

**选择理由**:
- ✅ 性能优秀 (基于Starlette + Pydantic)
- ✅ 自动生成OpenAPI文档
- ✅ 异步支持 (async/await)
- ✅ 类型提示,减少bug
- ✅ AI库生态丰富 (LangChain, OpenAI SDK)

**项目结构**:
```
backend/
├── app/
│   ├── api/              # API路由
│   │   ├── v1/
│   │   │   ├── projects.py
│   │   │   ├── reports.py
│   │   │   └── users.py
│   ├── core/             # 核心配置
│   │   ├── config.py
│   │   ├── security.py
│   ├── models/           # 数据模型
│   ├── schemas/          # Pydantic模型
│   ├── services/         # 业务逻辑
│   │   ├── collectors/   # 数据采集
│   │   ├── analyzers/    # AI分析
│   │   └── reporters/    # 报告生成
│   └── main.py           # 入口文件
├── tests/
├── requirements.txt
└── Dockerfile
```

---

### 异步任务队列

**Celery + Redis** ✅

**选择理由**:
- ✅ 成熟稳定
- ✅ 支持定时任务 (Celery Beat)
- ✅ 任务重试机制
- ✅ 监控工具完善 (Flower)

**任务类型**:
```python
# tasks/collectors.py
from celery import Celery

app = Celery('tasks', broker='redis://localhost:6379/0')

# 每5分钟执行
@app.task
def collect_twitter_data():
    """采集Twitter数据"""
    pass

# 每小时执行
@app.task
def update_social_metrics():
    """更新社交指标"""
    pass

# 每天早上9点执行
@app.task
def generate_daily_report():
    """生成每日报告"""
    pass
```

---

### 数据采集

**多种方案混合** ✅

| 数据源 | 技术方案 | 备注 |
|--------|----------|------|
| X/Twitter | Tweepy (官方API) | 付费计划 $100/月 |
| Telegram | Telethon (MTProto) | 免费,需注册开发者 |
| YouTube | YouTube Data API v3 | 每日配额10,000 |
| 链上数据 | Web3.py + Infura | 免费额度100k请求/天 |
| CoinGecko | CoinGecko API | 免费50次/分钟 |
| GitHub | PyGithub | 5,000请求/小时 |

**爬虫框架**:
```python
# 备用方案 (API受限时)
from playwright.async_api import async_playwright

async def scrape_twitter():
    async with async_playwright() as p:
        browser = await p.chromium.launch()
        page = await browser.new_page()
        # 模拟登录 + 数据抓取
```

---

### AI分析引擎

**LangChain + OpenAI/Anthropic** ✅

**架构设计**:
```python
from langchain.chat_models import ChatAnthropic
from langchain.chains import LLMChain
from langchain.prompts import ChatPromptTemplate

# AI评分链
scoring_chain = LLMChain(
    llm=ChatAnthropic(model="claude-3-sonnet-20240229"),
    prompt=ChatPromptTemplate.from_messages([
        ("system", "你是Web3项目分析专家..."),
        ("user", "分析以下项目:\n{project_data}")
    ])
)

# 白皮书分析链
whitepaper_chain = LLMChain(...)

# 风险识别链
risk_chain = LLMChain(...)
```

**模型选择**:
| 任务 | 模型 | 成本 |
|------|------|------|
| 文本分析 | Claude 3 Sonnet | $3/百万tokens |
| 评分计算 | GPT-4o-mini | $0.15/百万tokens |
| 报告生成 | Claude 3 Opus | $15/百万tokens |
| 情感分析 | 本地Bert模型 | 免费 |

**成本估算**:
- 每个项目分析: ~10,000 tokens
- 每日100个项目: $3-5/天
- 月成本: ~$150

---

## 🗄️ 数据存储

### 主数据库

**PostgreSQL 15** ✅

**选择理由**:
- ✅ ACID事务保证
- ✅ JSONB字段 (灵活存储)
- ✅ 全文搜索 (pg_trgm)
- ✅ TimescaleDB扩展 (时序数据)

**配置**:
```sql
-- 安装扩展
CREATE EXTENSION IF NOT EXISTS pg_trgm;       -- 模糊搜索
CREATE EXTENSION IF NOT EXISTS timescaledb;   -- 时序数据

-- 创建超表 (时序优化)
SELECT create_hypertable('social_metrics', 'snapshot_time');
SELECT create_hypertable('onchain_metrics', 'snapshot_time');
```

---

### 缓存层

**Redis 7** ✅

**使用场景**:
```python
# 1. 热点数据缓存
redis.setex('projects:hot', 300, json.dumps(hot_projects))

# 2. 去重集合
redis.sadd('processed_tweets', tweet_id)

# 3. 限流计数
redis.incr(f'api_calls:{user_id}:{hour}')

# 4. 任务队列 (Celery)
# 5. WebSocket Session存储
```

---

### 对象存储

**AWS S3 / Cloudflare R2** ✅

**存储内容**:
- 白皮书PDF文件
- 项目Logo图片
- 每日报告归档
- 数据备份

**Cloudflare R2优势**:
- ✅ 兼容S3 API
- ✅ 零出口流量费用
- ✅ 价格更低 ($0.015/GB/月)

---

### 向量数据库 (可选)

**Pinecone / Qdrant** 

**使用场景**:
- 项目相似度搜索
- 白皮书语义检索
- 历史百倍币特征匹配

**实现**:
```python
from pinecone import Pinecone

pc = Pinecone(api_key="xxx")
index = pc.Index("projects")

# 存储项目向量
index.upsert(vectors=[
    ("project-1", embedding, {"name": "XXX Protocol"})
])

# 相似度搜索
results = index.query(
    vector=query_embedding,
    top_k=5,
    include_metadata=True
)
```

---

## 🚀 部署方案

### 前端部署

**Vercel** ✅ (推荐)

**优势**:
- ✅ 零配置部署
- ✅ 全球CDN
- ✅ 免费HTTPS
- ✅ 自动Git集成
- ✅ 免费额度充足

**免费额度**:
- 100GB带宽/月
- 100GB构建时间/月
- 无限部署次数

---

### 后端部署

**方案对比**:

| 方案 | 成本 | 扩展性 | 复杂度 | 推荐度 |
|------|------|--------|--------|--------|
| Railway.app | $5起/月 | ⭐⭐⭐ | ⭐ | ⭐⭐⭐⭐⭐ |
| Render | 免费/$7起 | ⭐⭐⭐ | ⭐ | ⭐⭐⭐⭐ |
| Fly.io | 免费/$1.94起 | ⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ |
| AWS EC2 | $10起/月 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |
| Docker + VPS | $5起/月 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |

**MVP阶段推荐**: Railway.app ✅

**配置文件**:
```yaml
# railway.toml
[build]
builder = "DOCKERFILE"
dockerfilePath = "./Dockerfile"

[deploy]
startCommand = "uvicorn app.main:app --host 0.0.0.0 --port $PORT"
healthcheckPath = "/health"
restartPolicyType = "ON_FAILURE"
```

---

### 数据库托管

**Supabase** ✅ (推荐)

**优势**:
- ✅ PostgreSQL托管
- ✅ 自动备份
- ✅ 免费500MB
- ✅ 内置认证系统
- ✅ 实时订阅功能

**替代方案**:
- Neon.tech (无服务器Postgres)
- PlanetScale (MySQL,免费10GB)

---

### Redis托管

**Upstash** ✅

**优势**:
- ✅ 按请求计费
- ✅ 免费10,000次/天
- ✅ 全球边缘部署
- ✅ REST API (无需连接池)

---

## 🔐 安全方案

### 认证授权

**Supabase Auth** ✅

**支持**:
- 邮箱/密码
- OAuth (Google, GitHub)
- 魔法链接
- JWT令牌

---

### API安全

**措施**:
```python
# 1. 速率限制
from slowapi import Limiter

limiter = Limiter(key_func=lambda: request.client.host)

@app.get("/api/projects")
@limiter.limit("100/minute")
async def get_projects():
    pass

# 2. API密钥管理
from app.core.security import verify_api_key

@app.get("/api/premium/report")
async def premium_report(api_key: str = Depends(verify_api_key)):
    pass

# 3. CORS配置
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://yourdomain.com"],
    allow_credentials=True,
)
```

---

## 📊 监控与日志

### 应用监控

**Sentry** ✅

**功能**:
- 错误追踪
- 性能监控
- 用户会话回放

**免费额度**: 5,000 errors/月

---

### 日志管理

**Better Stack (Logtail)** ✅

**特性**:
- 结构化日志
- 实时搜索
- 告警规则

---

### 数据监控

**Grafana + Prometheus**

**指标**:
- API响应时间
- 数据库查询性能
- 任务队列延迟
- 爬虫成功率

---

## 📦 开发工具

### 代码质量

```json
// package.json (前端)
{
  "devDependencies": {
    "eslint": "^8.0.0",
    "prettier": "^3.0.0",
    "typescript": "^5.0.0"
  }
}
```

```txt
# requirements-dev.txt (后端)
black==23.0.0           # 代码格式化
ruff==0.1.0             # 超快linter
mypy==1.0.0             # 类型检查
pytest==7.0.0           # 测试框架
pytest-cov==4.0.0       # 覆盖率
```

---

### CI/CD

**GitHub Actions** ✅

```yaml
# .github/workflows/test.yml
name: Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run tests
        run: pytest
      - name: Check types
        run: mypy .
```

---

## 💰 成本预估 (MVP阶段)

| 服务 | 方案 | 月成本 |
|------|------|--------|
| 前端托管 | Vercel | $0 (免费) |
| 后端服务 | Railway | $5 |
| 数据库 | Supabase | $0 (免费) |
| Redis | Upstash | $0 (免费) |
| 对象存储 | Cloudflare R2 | $1 |
| AI分析 | Claude API | $150 |
| 监控 | Sentry | $0 (免费) |
| Twitter API | Basic | $100 |
| **总计** | | **$256/月** |

**扩展阶段** (1000+用户):
- 后端: Railway Pro $20
- 数据库: Supabase Pro $25
- CDN: Cloudflare Pro $20
- **总计**: ~$420/月

---

## ✅ 技术选型总结

| 层级 | 技术 | 理由 |
|------|------|------|
| 前端 | Next.js + Shadcn/ui | 全栈能力、免费部署 |
| 后端 | FastAPI + Celery | 性能、AI生态 |
| 数据库 | PostgreSQL + Redis | 稳定、功能强大 |
| AI | Claude + LangChain | 准确度、成本平衡 |
| 部署 | Vercel + Railway | 简单、成本低 |
| 监控 | Sentry + Better Stack | 免费额度充足 |

---

**文档版本**: v1.0  
**最后更新**: 2025-10-02  
**审核人**: 技术负责人

