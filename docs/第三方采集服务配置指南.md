# 第三方采集服务配置指南

**完成时间**: 2025-01-07  
**目的**: 使用Apify等第三方服务替代Twitter官方API，实现低成本高频数据采集

---

## 📋 配置清单

### 必须配置 (P0)

#### 1. Apify API (Twitter采集)

**注册步骤**:
1. 访问 https://apify.com/
2. 点击 "Sign Up" 注册账号
3. 进入 Dashboard → Settings → Integrations
4. 复制 "Personal API token"

**配置环境变量**:
```bash
# backend/.env
APIFY_API_KEY=apify_api_xxxxxxxxxxxxxxxxxxxxxxxx
APIFY_TWITTER_ACTOR_ID=apify/twitter-scraper
```

**定价**:
- **免费套餐**: $5 额度 (约1000次调用)
- **Starter套餐**: $49/月 (100k actor runs) ⭐推荐
- **Team套餐**: $499/月 (1M actor runs)

**配额说明**:
- 每次采集 = 1个actor run
- 每15分钟采集一次 = 96次/天 = 2,880次/月
- Starter套餐完全够用（100k次/月 >> 2,880次/月）

---

#### 2. Telegram API (免费)

**注册步骤**:
1. 访问 https://my.telegram.org/
2. 使用手机号登录
3. 点击 "API development tools"
4. 填写应用信息:
   - App title: `Web3 Alpha Hunter`
   - Short name: `web3hunter`
   - Platform: `Other`
5. 点击 "Create application"
6. 复制 `api_id` 和 `api_hash`

**配置环境变量**:
```bash
# backend/.env
TELEGRAM_API_ID=12345678
TELEGRAM_API_HASH=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

**限制**:
- 完全免费
- 无调用次数限制
- 需要遵守 Telegram 服务条款

---

#### 3. AI分析服务 (至少配置一个)

##### 方案A: DeepSeek (推荐 - 国内)

**注册步骤**:
1. 访问 https://platform.deepseek.com/
2. 注册账号
3. 进入 "API Keys" 页面
4. 创建新密钥

**配置环境变量**:
```bash
# backend/.env
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

**定价**:
- 输入: ¥1/百万tokens
- 输出: ¥2/百万tokens
- 每月成本: ~¥50-150 (取决于分析量)

##### 方案B: OpenAI (可选)

```bash
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

##### 方案C: Anthropic Claude (可选)

```bash
ANTHROPIC_API_KEY=sk-ant-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

---

## 🚀 快速配置流程

### 步骤1: 安装依赖

```bash
cd /Users/xinghailong/Documents/soft/faxianjihui/backend
pip install -r requirements.txt
```

### 步骤2: 配置环境变量

```bash
# 复制模板文件
cp .env.example .env

# 编辑 .env 文件，填写以下必需配置
nano .env
```

**必须填写的字段**:
```bash
# AI分析
DEEPSEEK_API_KEY=sk-xxxxxx

# Twitter采集
APIFY_API_KEY=apify_api_xxxxxx

# Telegram采集
TELEGRAM_API_ID=12345678
TELEGRAM_API_HASH=xxxxxx
```

### 步骤3: 重启Celery服务

```bash
# 停止旧服务
./stop-celery.sh

# 启动新服务
./start-celery.sh
```

### 步骤4: 验证配置

```bash
# 查看Worker日志
tail -f /tmp/celery-worker.log

# 应该看到:
# ✅ Apify Twitter collector initialized
# ✅ Telegram client initialized
```

---

## 🧪 测试采集

### 测试Apify Twitter采集

```bash
cd backend
python3 -c "
from app.services.collectors.twitter_apify import twitter_apify_collector
projects = twitter_apify_collector.collect_and_extract(hours=24)
print(f'✅ Collected {len(projects)} projects')
for p in projects[:3]:
    print(f'  - {p.get(\"name\")}: {p.get(\"description\")[:50]}...')
"
```

**预期输出**:
```
✅ Apify Twitter collector initialized
🔍 Searching tweets for: presale (max: 30)
✅ Found 25 tweets for query: presale
...
✅ Collected 15 projects
  - NewToken: Announcing presale for NewToken - revolutionary...
  - AirdropProject: Join our airdrop campaign...
```

### 测试Telegram采集

```bash
python3 -c "
import asyncio
from app.services.collectors.telegram import telegram_collector

async def test():
    await telegram_collector.start_client()
    messages = await telegram_collector.get_channel_messages('@cryptonewsflash', limit=10)
    print(f'✅ Collected {len(messages)} messages')
    for m in messages[:3]:
        print(f'  - {m.get(\"text\", \"\")[:50]}...')

asyncio.run(test())
"
```

---

## 📊 成本预估

### 每月总成本: $49-99

| 服务 | 月成本 | 说明 |
|------|--------|------|
| **Apify** | $49 | Starter套餐，100k次调用/月 |
| **Telegram** | $0 | 完全免费 |
| **CoinGecko** | $0 | 免费API (50次/分钟) |
| **DeepSeek** | ¥50-150 ($7-21) | 按使用量计费 |
| **总计** | **$56-70/月** | 远低于Twitter官方API ($100/月) |

### 每日数据采集量

| 平台 | 采集频率 | 每次数据量 | 每日总量 |
|------|----------|------------|----------|
| **Twitter** | 15分钟 | 50-200条 | 4,800-19,200条 |
| **Telegram** | 15分钟 | 30-100条 | 2,880-9,600条 |
| **CoinGecko** | 30分钟 | 20-30个项目 | 960-1,440个项目 |
| **总计** | - | - | **~10,000-30,000条/天** |

---

## 🔧 故障排查

### 问题1: Apify报错 "API key not configured"

**解决方案**:
```bash
# 1. 检查 .env 文件
cat backend/.env | grep APIFY_API_KEY

# 2. 确认格式正确
APIFY_API_KEY=apify_api_xxxxxxxxx  # 应该以 apify_api_ 开头

# 3. 重启Celery
./stop-celery.sh && ./start-celery.sh
```

### 问题2: Telegram报错 "Failed to initialize client"

**解决方案**:
```bash
# 1. 检查API ID和Hash
cat backend/.env | grep TELEGRAM

# 2. 确认两个值都已配置
TELEGRAM_API_ID=12345678          # 数字
TELEGRAM_API_HASH=abcd1234efgh    # 32位字符串

# 3. 删除session文件（如果存在）
rm backend/web3_alpha_hunter.session

# 4. 重启Celery
./stop-celery.sh && ./start-celery.sh
```

### 问题3: Celery日志显示 "No Twitter collector configured"

**解决方案**:
```bash
# 确保至少配置了一个Twitter采集器
# 优先级: APIFY_API_KEY > TWITTER_BEARER_TOKEN

# 检查配置
cat backend/.env | grep -E "APIFY_API_KEY|TWITTER_BEARER_TOKEN"
```

---

## 📈 监控与优化

### 查看采集统计

```bash
# 数据库查询
cd backend
python3 << EOF
from app.db.session import SessionLocal
from sqlalchemy import text

db = SessionLocal()
result = db.execute(text("""
    SELECT platform, data_collected, projects_discovered 
    FROM platform_daily_stats 
    WHERE stat_date = CURRENT_DATE
"""))

for row in result:
    print(f"{row[0]:12} | 采集:{row[1]:5} | 项目:{row[2]:5}")

db.close()
EOF
```

### 调整采集频率

**降低频率（节省配额）**:
```python
# backend/app/tasks/celery_app.py
"collect-twitter-data": {
    "schedule": crontab(minute="*/30"),  # 从15分钟改为30分钟
}
```

**提高频率（实时性更强）**:
```python
"collect-twitter-data": {
    "schedule": crontab(minute="*/10"),  # 从15分钟改为10分钟
}
```

---

## ✅ 验证清单

完成配置后，请逐项检查:

- [ ] Apify账号已注册，API Key已配置
- [ ] Telegram开发者账号已注册，API ID/Hash已配置
- [ ] DeepSeek/OpenAI/Claude至少一个已配置
- [ ] `.env` 文件已创建，所有必需字段已填写
- [ ] 依赖已安装 (`pip install -r requirements.txt`)
- [ ] Celery服务已重启
- [ ] Worker日志显示采集器初始化成功
- [ ] 手动测试Twitter采集成功
- [ ] 手动测试Telegram采集成功
- [ ] 管理面板显示数据统计正常

---

## 🎯 后续优化建议

### P1 - 短期 (1周内):
1. 监控Apify配额使用情况
2. 根据数据质量调整关键词列表
3. 优化KOL监控列表

### P2 - 中期 (1月内):
1. 添加更多Telegram频道
2. 实现数据去重算法优化
3. 添加Discord采集器

### P3 - 长期 (3月内):
1. 接入Reddit数据源
2. 接入Medium RSS
3. 实现多维度数据融合分析

---

## 📚 相关文档

- **Apify文档**: https://docs.apify.com/
- **Telegram API文档**: https://core.telegram.org/api
- **DeepSeek文档**: https://platform.deepseek.com/docs
- **项目总体架构**: `/docs/02-技术实现/01-技术选型.md`

---

**配置完成后**，系统将自动开始高频数据采集，每15分钟从Twitter和Telegram获取最新Web3项目信息！
