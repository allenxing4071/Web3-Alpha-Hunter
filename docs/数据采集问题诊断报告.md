# 🔍 数据采集问题诊断报告

**诊断时间**: 2025-01-07  
**问题**: 管理面板显示所有平台数据为0  

---

## ❌ 发现的问题

### 1️⃣ **Twitter API未配置**
```
WARNING | Twitter Bearer Token not configured
WARNING | Twitter client not available
Result: 0 tweets collected
```

**影响**: 无法采集Twitter数据

### 2️⃣ **Telegram API未配置**
```
WARNING | Telegram API credentials not configured
```

**影响**: 无法采集Telegram数据

### 3️⃣ **数据库无数据**
```sql
SELECT COUNT(*) FROM projects;
-- 结果: 0
```

**影响**: 没有任何项目数据

### 4️⃣ **平台统计表缺失**
```sql
SELECT name FROM sqlite_master WHERE type='table' AND name LIKE 'platform%';
-- 结果: 空
```

**影响**: 无法记录平台采集统计

---

## ✅ 正常运行的部分

### 1. Celery Worker & Beat 正常
- ✅ Worker进程: 运行中 (12个子进程)
- ✅ Beat进程: 运行中 (定时调度正常)
- ✅ 任务调度: 每5分钟触发Twitter采集
- ✅ 任务执行: 任务被接收并执行

### 2. CoinGecko采集器正常初始化
```
✅ CoinGecko collector initialized
```

---

## 🔧 问题根本原因

### 核心问题矩阵:

| 数据源 | API配置 | 采集器状态 | 数据量 | 问题 |
|--------|---------|------------|--------|------|
| Twitter | ❌ 未配置 | ⚠️ Mock模式 | 0 | API Token缺失 |
| Telegram | ❌ 未配置 | ⚠️ Mock模式 | 0 | API凭证缺失 |
| CoinGecko | ✅ 正常 | ✅ 已初始化 | 0 | 未执行采集 |
| Discord | ❓ 未知 | ❓ 未知 | 0 | 未检查 |

---

## 📋 当前系统流程

```
Celery Beat (调度器)
    ↓
每5分钟发送任务 → app.tasks.collectors.collect_twitter_data
    ↓
Celery Worker接收任务
    ↓
调用 twitter_collector.collect_and_extract()
    ↓
检查: Twitter Bearer Token
    ↓
❌ 未配置 → 返回空结果
    ↓
任务成功但无数据: {'projects_found': 0, 'projects_saved': 0}
```

---

## 🎯 解决方案

### 方案A: 配置真实API密钥 (推荐)

#### 1. Twitter API配置
```bash
# 设置环境变量
export TWITTER_BEARER_TOKEN="your_bearer_token_here"

# 或在数据库中配置 (已有AI配置表结构)
```

**获取Twitter API密钥**:
1. 访问 https://developer.twitter.com/
2. 创建App
3. 获取 Bearer Token
4. 在管理面板 → AI配置 → 添加Twitter配置

#### 2. Telegram API配置
```bash
export TELEGRAM_API_ID="your_api_id"
export TELEGRAM_API_HASH="your_api_hash"
export TELEGRAM_PHONE="your_phone_number"
```

**获取Telegram API密钥**:
1. 访问 https://my.telegram.org/apps
2. 创建应用获取 API ID 和 API Hash

#### 3. 重启Celery服务
```bash
# 在管理面板点击:
1. 停止 Worker
2. 停止 Beat
3. 启动 Worker
4. 启动 Beat
```

---

### 方案B: 创建平台统计表 (必需)

```sql
-- 创建平台搜索规则表
CREATE TABLE IF NOT EXISTS platform_search_rules (
    platform TEXT PRIMARY KEY,
    enabled BOOLEAN DEFAULT true,
    priority INTEGER DEFAULT 5,
    frequency_minutes INTEGER DEFAULT 5,
    search_keywords JSON,
    min_engagement INTEGER DEFAULT 10,
    min_author_followers INTEGER DEFAULT 500,
    max_results_per_run INTEGER DEFAULT 100,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建平台每日统计表
CREATE TABLE IF NOT EXISTS platform_daily_stats (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    platform TEXT NOT NULL,
    stat_date DATE NOT NULL,
    data_collected INTEGER DEFAULT 0,
    projects_discovered INTEGER DEFAULT 0,
    kols_discovered INTEGER DEFAULT 0,
    projects_recommended INTEGER DEFAULT 0,
    projects_approved INTEGER DEFAULT 0,
    projects_rejected INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(platform, stat_date)
);

-- 插入初始配置
INSERT OR IGNORE INTO platform_search_rules (platform, enabled, frequency_minutes) 
VALUES 
    ('twitter', true, 5),
    ('telegram', true, 15),
    ('discord', true, 30);
```

---

### 方案C: 使用CoinGecko作为初始数据源 (快速测试)

CoinGecko不需要API密钥（免费API），可以立即采集数据：

```bash
# 手动触发一次CoinGecko采集
curl -X POST http://localhost:8000/api/v1/admin/collect/coingecko
```

---

## 📊 验证步骤

### 1. 配置API后验证
```bash
# 检查Twitter配置
echo $TWITTER_BEARER_TOKEN

# 手动触发采集测试
curl -X POST http://localhost:8000/api/v1/platforms/twitter/collect
```

### 2. 查看日志
```bash
# Worker日志
tail -f /tmp/celery_worker.log | grep -E "collect|Twitter|项目"

# Beat日志  
tail -f /tmp/celery_beat.log | grep "Scheduler"
```

### 3. 检查数据库
```bash
# 查看项目数
sqlite3 web3hunter.db "SELECT COUNT(*) FROM projects;"

# 查看平台统计
sqlite3 web3hunter.db "SELECT * FROM platform_daily_stats WHERE stat_date = date('now');"
```

---

## ⚡ 快速行动计划

### 立即执行 (5分钟内):

1. **创建数据库表**
   ```bash
   cd /Users/xinghailong/Documents/soft/faxianjihui/backend
   sqlite3 web3hunter.db < scripts/create_platform_tables.sql
   ```

2. **测试CoinGecko采集** (无需API密钥)
   ```bash
   curl -X POST http://localhost:8000/api/v1/admin/collect/coingecko
   ```

3. **等待30秒后检查**
   ```bash
   sqlite3 web3hunter.db "SELECT COUNT(*) FROM projects;"
   ```

### 短期执行 (1小时内):

4. **申请Twitter Developer账号**
5. **配置Twitter API密钥**
6. **重启Celery服务**
7. **观察数据采集**

---

## 📈 预期结果

### 配置完成后:

| 平台 | 采集频率 | 预期数据量/天 |
|------|----------|---------------|
| Twitter | 每5分钟 | 50-200个项目 |
| Telegram | 每15分钟 | 20-100个项目 |
| CoinGecko | 每30分钟 | 10-50个项目 |
| Discord | 每30分钟 | 5-30个项目 |

### 管理面板显示:

```
Twitter/X:
- 采集数据: 156
- 发现项目: 23
- 发现KOL: 12
- AI推荐: 8

Telegram:
- 采集数据: 89
- 发现项目: 15
- 发现KOL: 0
- AI推荐: 5
```

---

## 🎯 总结

**当前状态**: 🟡 系统架构完整，但缺少API配置和数据

**核心问题**: 
1. ❌ Twitter/Telegram API未配置
2. ❌ 平台统计表缺失
3. ❌ 数据库无初始数据

**解决优先级**:
1. **P0**: 创建platform统计表 (立即)
2. **P0**: 测试CoinGecko采集 (立即)
3. **P1**: 配置Twitter API (1小时内)
4. **P2**: 配置Telegram API (按需)

**预计恢复时间**: 5分钟 (CoinGecko) + 1小时 (Twitter)

