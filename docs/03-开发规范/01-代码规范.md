# 代码规范文档

## 🎯 规范目标

1. **一致性**: 团队成员编写的代码风格统一
2. **可读性**: 代码易于理解和维护
3. **可维护性**: 降低技术债务,便于重构
4. **质量保证**: 通过规范减少bug

---

## 📁 项目结构规范

### 前端项目结构 (Next.js)

```
web3-alpha-hunter-web/
├── src/
│   ├── app/                    # App Router页面
│   │   ├── (auth)/            # 认证相关页面组
│   │   │   ├── login/
│   │   │   └── register/
│   │   ├── (dashboard)/       # 仪表板页面组
│   │   │   ├── projects/
│   │   │   ├── reports/
│   │   │   └── watchlist/
│   │   ├── layout.tsx         # 根布局
│   │   └── page.tsx           # 首页
│   ├── components/            # React组件
│   │   ├── ui/               # UI基础组件
│   │   │   ├── button.tsx
│   │   │   ├── card.tsx
│   │   │   └── ...
│   │   ├── projects/         # 项目相关组件
│   │   │   ├── ProjectCard.tsx
│   │   │   ├── ProjectList.tsx
│   │   │   └── ScoreRadar.tsx
│   │   └── layout/           # 布局组件
│   │       ├── Header.tsx
│   │       └── Sidebar.tsx
│   ├── lib/                  # 工具库
│   │   ├── api.ts           # API客户端
│   │   ├── utils.ts         # 工具函数
│   │   └── constants.ts     # 常量
│   ├── hooks/               # 自定义Hooks
│   │   ├── useProjects.ts
│   │   └── useWebSocket.ts
│   ├── store/               # 状态管理
│   │   ├── projectStore.ts
│   │   └── userStore.ts
│   ├── types/               # TypeScript类型定义
│   │   ├── project.ts
│   │   └── api.ts
│   └── styles/              # 全局样式
│       └── globals.css
├── public/                  # 静态资源
├── .env.local              # 环境变量
├── next.config.js
├── tailwind.config.ts
├── tsconfig.json
└── package.json
```

---

### 后端项目结构 (FastAPI)

```
web3-alpha-hunter-api/
├── app/
│   ├── api/                 # API路由
│   │   └── v1/
│   │       ├── __init__.py
│   │       ├── projects.py
│   │       ├── reports.py
│   │       ├── users.py
│   │       └── auth.py
│   ├── core/                # 核心配置
│   │   ├── __init__.py
│   │   ├── config.py       # 配置管理
│   │   ├── security.py     # 安全相关
│   │   └── deps.py         # 依赖注入
│   ├── models/              # 数据库模型
│   │   ├── __init__.py
│   │   ├── project.py
│   │   ├── user.py
│   │   └── report.py
│   ├── schemas/             # Pydantic模型
│   │   ├── __init__.py
│   │   ├── project.py
│   │   └── user.py
│   ├── services/            # 业务逻辑
│   │   ├── collectors/     # 数据采集
│   │   │   ├── twitter.py
│   │   │   ├── telegram.py
│   │   │   └── onchain.py
│   │   ├── analyzers/      # AI分析
│   │   │   ├── scorer.py
│   │   │   └── risk.py
│   │   └── reporters/      # 报告生成
│   │       └── daily.py
│   ├── tasks/               # Celery任务
│   │   ├── __init__.py
│   │   ├── collect.py
│   │   └── analyze.py
│   ├── db/                  # 数据库
│   │   ├── __init__.py
│   │   ├── session.py      # 数据库会话
│   │   └── init_db.py      # 数据库初始化
│   ├── tests/               # 测试
│   │   ├── __init__.py
│   │   ├── test_projects.py
│   │   └── conftest.py
│   └── main.py              # 应用入口
├── alembic/                 # 数据库迁移
├── .env
├── requirements.txt
├── requirements-dev.txt
└── Dockerfile
```

---

## 💻 前端代码规范

### TypeScript规范

#### 1. 命名规范

```typescript
// ✅ 推荐
// 组件: PascalCase
const ProjectCard: React.FC<ProjectCardProps> = ({ project }) => {}

// 函数: camelCase
function calculateScore(data: ProjectData): number {}

// 常量: UPPER_SNAKE_CASE
const API_BASE_URL = 'https://api.example.com'

// 类型/接口: PascalCase
interface Project {
  id: string
  name: string
}

type ProjectGrade = 'S' | 'A' | 'B' | 'C'

// 枚举: PascalCase
enum ProjectCategory {
  DeFi = 'DeFi',
  NFT = 'NFT',
  GameFi = 'GameFi'
}

// ❌ 避免
const projectcard = () => {}        // 组件应该PascalCase
const Calculate_Score = () => {}    // 不要用下划线
interface project {}                // 类型应该PascalCase
```

#### 2. 类型定义

```typescript
// ✅ 推荐: 明确的类型定义
interface Project {
  id: string
  name: string
  score: number
  grade: ProjectGrade
  discoveredAt: Date
}

// 使用类型而非any
function getProject(id: string): Promise<Project> {
  // ...
}

// 联合类型
type ApiResponse<T> = 
  | { success: true; data: T }
  | { success: false; error: ApiError }

// ❌ 避免
function getProject(id: any): any {  // 不要使用any
  // ...
}
```

#### 3. React组件规范

```typescript
// ✅ 推荐: 函数式组件 + TypeScript
interface ProjectCardProps {
  project: Project
  onSelect?: (id: string) => void
}

export const ProjectCard: React.FC<ProjectCardProps> = ({ 
  project,
  onSelect 
}) => {
  // Hooks在顶部
  const [isExpanded, setIsExpanded] = useState(false)
  const { data, isLoading } = useProjectDetails(project.id)
  
  // 事件处理函数
  const handleClick = useCallback(() => {
    onSelect?.(project.id)
  }, [project.id, onSelect])
  
  // 早返回模式
  if (isLoading) return <Skeleton />
  if (!data) return null
  
  // JSX
  return (
    <Card onClick={handleClick}>
      <CardHeader>
        <h3>{project.name}</h3>
        <GradeBadge grade={project.grade} />
      </CardHeader>
      <CardContent>
        {/* ... */}
      </CardContent>
    </Card>
  )
}

// ❌ 避免: 类组件
class ProjectCard extends React.Component {
  // 不推荐使用类组件
}
```

#### 4. Hooks使用规范

```typescript
// ✅ 推荐: 自定义Hook
export function useProjects(filters: ProjectFilters) {
  const [projects, setProjects] = useState<Project[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [error, setError] = useState<Error | null>(null)
  
  useEffect(() => {
    const fetchProjects = async () => {
      try {
        setIsLoading(true)
        const data = await api.getProjects(filters)
        setProjects(data)
      } catch (err) {
        setError(err as Error)
      } finally {
        setIsLoading(false)
      }
    }
    
    fetchProjects()
  }, [filters]) // 依赖项明确
  
  return { projects, isLoading, error }
}

// 使用
const { projects, isLoading } = useProjects({ grade: 'S' })
```

---

### CSS/Tailwind规范

```tsx
// ✅ 推荐: Tailwind类名组织
<div className={cn(
  // 布局
  "flex items-center justify-between",
  // 间距
  "p-4 gap-2",
  // 样式
  "bg-gray-900 border border-gray-700 rounded-lg",
  // 响应式
  "md:p-6 lg:flex-row",
  // 状态
  "hover:shadow-lg transition-shadow",
  // 条件类
  grade === 'S' && "border-gold shadow-gold"
)}>
  {/* ... */}
</div>

// ❌ 避免: 混乱的类名顺序
<div className="hover:shadow-lg p-4 bg-gray-900 flex border border-gray-700">
```

---

## 🐍 后端代码规范

### Python规范 (PEP 8 + Black)

#### 1. 命名规范

```python
# ✅ 推荐
# 变量/函数: snake_case
def calculate_project_score(project_data: dict) -> float:
    pass

# 类: PascalCase
class ProjectAnalyzer:
    pass

# 常量: UPPER_SNAKE_CASE
API_VERSION = "v1"
MAX_RETRIES = 3

# 私有变量: _开头
class ProjectService:
    def __init__(self):
        self._cache = {}
        
    def _internal_method(self):
        pass

# ❌ 避免
def CalculateScore():          # 应该snake_case
class project_analyzer:        # 应该PascalCase
API_version = "v1"             # 常量应该大写
```

#### 2. 类型提示

```python
# ✅ 推荐: 使用类型提示
from typing import List, Optional, Dict, Any
from datetime import datetime

def get_project(
    project_id: str,
    include_metrics: bool = False
) -> Optional[Dict[str, Any]]:
    """获取项目详情
    
    Args:
        project_id: 项目ID
        include_metrics: 是否包含指标数据
        
    Returns:
        项目数据字典,如果不存在返回None
    """
    pass

# Pydantic模型
from pydantic import BaseModel, Field

class ProjectCreate(BaseModel):
    name: str = Field(..., min_length=1, max_length=255)
    symbol: str = Field(..., max_length=50)
    blockchain: str
    
    class Config:
        json_schema_extra = {
            "example": {
                "name": "XXX Protocol",
                "symbol": "XXX",
                "blockchain": "Ethereum"
            }
        }

# ❌ 避免: 没有类型提示
def get_project(project_id):
    pass
```

#### 3. FastAPI路由规范

```python
# ✅ 推荐
from fastapi import APIRouter, Depends, HTTPException, Query
from typing import List

router = APIRouter(prefix="/projects", tags=["projects"])

@router.get(
    "",
    response_model=ProjectListResponse,
    summary="获取项目列表",
    description="根据筛选条件获取项目列表"
)
async def list_projects(
    grade: Optional[ProjectGrade] = Query(None, description="项目等级"),
    min_score: float = Query(0, ge=0, le=100, description="最低评分"),
    limit: int = Query(20, ge=1, le=100, description="每页数量"),
    skip: int = Query(0, ge=0, description="跳过数量"),
    current_user: User = Depends(get_current_user)
) -> ProjectListResponse:
    """
    获取项目列表
    
    - **grade**: 筛选等级 (S/A/B/C)
    - **min_score**: 最低评分
    - **limit**: 返回数量
    """
    projects = await project_service.get_projects(
        grade=grade,
        min_score=min_score,
        limit=limit,
        skip=skip
    )
    
    return ProjectListResponse(
        success=True,
        data={"projects": projects}
    )

# ❌ 避免
@router.get("/projects")
def get_projects(grade=None, score=None):  # 缺少类型提示和文档
    pass
```

#### 4. 异常处理

```python
# ✅ 推荐
from app.core.exceptions import ProjectNotFoundError

async def get_project_by_id(project_id: str) -> Project:
    """获取项目"""
    try:
        project = await db.projects.find_one({"_id": project_id})
        if not project:
            raise ProjectNotFoundError(f"Project {project_id} not found")
        return project
    except DatabaseError as e:
        logger.error(f"Database error: {e}")
        raise HTTPException(
            status_code=500,
            detail="Database operation failed"
        )

# ❌ 避免
def get_project(project_id):
    try:
        return db.find(project_id)
    except:  # 不要使用裸except
        pass  # 不要静默失败
```

#### 5. 日志规范

```python
# ✅ 推荐
import logging

logger = logging.getLogger(__name__)

async def analyze_project(project_id: str):
    logger.info(f"Starting analysis for project {project_id}")
    
    try:
        result = await ai_service.analyze(project_id)
        logger.info(
            f"Analysis completed for {project_id}",
            extra={"project_id": project_id, "score": result.score}
        )
        return result
    except Exception as e:
        logger.error(
            f"Analysis failed for {project_id}: {str(e)}",
            exc_info=True
        )
        raise

# ❌ 避免
def analyze_project(project_id):
    print(f"Analyzing {project_id}")  # 不要使用print
    # 没有错误日志
```

---

## 🧪 测试规范

### 前端测试

```typescript
// ✅ 推荐: Jest + React Testing Library
import { render, screen, waitFor } from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import { ProjectCard } from './ProjectCard'

describe('ProjectCard', () => {
  const mockProject = {
    id: 'proj_123',
    name: 'Test Protocol',
    grade: 'S' as const,
    score: 92
  }
  
  it('should render project name', () => {
    render(<ProjectCard project={mockProject} />)
    expect(screen.getByText('Test Protocol')).toBeInTheDocument()
  })
  
  it('should call onSelect when clicked', async () => {
    const onSelect = jest.fn()
    render(<ProjectCard project={mockProject} onSelect={onSelect} />)
    
    await userEvent.click(screen.getByRole('button'))
    expect(onSelect).toHaveBeenCalledWith('proj_123')
  })
})
```

### 后端测试

```python
# ✅ 推荐: Pytest + FastAPI TestClient
import pytest
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_list_projects():
    """测试获取项目列表"""
    response = client.get("/v1/projects?grade=S&limit=10")
    
    assert response.status_code == 200
    data = response.json()
    assert data["success"] is True
    assert len(data["data"]["projects"]) <= 10

@pytest.mark.asyncio
async def test_analyze_project():
    """测试项目分析"""
    project_id = "proj_test"
    result = await project_service.analyze(project_id)
    
    assert result.score >= 0
    assert result.score <= 100
    assert result.grade in ['S', 'A', 'B', 'C']
```

---

## 📝 注释规范

### Python Docstring

```python
def calculate_project_score(
    team_score: float,
    tech_score: float,
    community_score: float,
    weights: Optional[Dict[str, float]] = None
) -> float:
    """计算项目综合评分
    
    使用加权平均算法计算项目的综合评分。各维度评分范围0-100,
    最终返回综合评分也在0-100范围内。
    
    Args:
        team_score: 团队评分 (0-100)
        tech_score: 技术评分 (0-100)
        community_score: 社区评分 (0-100)
        weights: 权重字典,默认使用预设权重
        
    Returns:
        综合评分 (0-100)
        
    Raises:
        ValueError: 如果任何评分不在0-100范围内
        
    Example:
        >>> calculate_project_score(90, 85, 80)
        85.0
    """
    pass
```

### TypeScript JSDoc

```typescript
/**
 * 计算项目评分
 * 
 * @param data - 项目原始数据
 * @param weights - 权重配置
 * @returns 综合评分对象
 * 
 * @example
 * ```ts
 * const score = calculateScore(projectData, defaultWeights)
 * console.log(score.overall) // 92.5
 * ```
 */
export function calculateScore(
  data: ProjectData,
  weights: ScoreWeights
): ProjectScore {
  // ...
}
```

---

## ✅ 代码检查工具

### 前端 (.eslintrc.json)

```json
{
  "extends": [
    "next/core-web-vitals",
    "plugin:@typescript-eslint/recommended"
  ],
  "rules": {
    "@typescript-eslint/no-unused-vars": "error",
    "@typescript-eslint/no-explicit-any": "warn",
    "react-hooks/exhaustive-deps": "warn"
  }
}
```

### 后端 (pyproject.toml)

```toml
[tool.black]
line-length = 88
target-version = ['py311']

[tool.ruff]
line-length = 88
select = ["E", "F", "I", "N", "W"]
ignore = ["E501"]

[tool.mypy]
python_version = "3.11"
strict = true
```

---

## 🚀 Git规范

### Commit Message

```bash
# ✅ 推荐格式: <type>(<scope>): <subject>

feat(projects): add S-grade filter to project list
fix(api): resolve rate limit error on Twitter collector
docs(readme): update deployment instructions
refactor(scorer): simplify score calculation algorithm
test(reports): add unit tests for daily report generator
chore(deps): upgrade FastAPI to 0.104.0

# Type类型:
# feat: 新功能
# fix: 修复bug
# docs: 文档
# refactor: 重构
# test: 测试
# chore: 构建/工具
# perf: 性能优化
```

### 分支管理

```bash
main           # 生产环境
├── develop    # 开发环境
│   ├── feature/s-grade-filter
│   ├── feature/telegram-collector
│   └── fix/rate-limit-error
```

---

**文档版本**: v1.0  
**最后更新**: 2025-10-02

