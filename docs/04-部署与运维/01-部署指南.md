# 部署指南

## 🎯 部署架构

```
                    ┌──────────────┐
                    │   用户请求    │
                    └──────┬───────┘
                           │
                    ┌──────▼───────┐
                    │  Cloudflare  │ (CDN + DDoS防护)
                    └──────┬───────┘
           ┌───────────────┴───────────────┐
           │                               │
    ┌──────▼────────┐            ┌────────▼────────┐
    │  Vercel       │            │  Railway.app    │
    │  (前端)        │            │  (后端API)       │
    └───────────────┘            └────────┬────────┘
                                          │
                    ┌─────────────────────┼─────────────────┐
                    │                     │                 │
            ┌───────▼──────┐    ┌────────▼──────┐  ┌──────▼──────┐
            │  Supabase    │    │  Upstash      │  │  Celery     │
            │  (PostgreSQL)│    │  (Redis)      │  │  Workers    │
            └──────────────┘    └───────────────┘  └─────────────┘
```

---

## 🚀 前端部署 (Vercel)

### 步骤1: 准备代码

确保项目根目录有以下文件:

```bash
web3-alpha-hunter-web/
├── package.json
├── next.config.js
├── .env.example
└── .gitignore
```

**next.config.js**:
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  env: {
    NEXT_PUBLIC_API_URL: process.env.NEXT_PUBLIC_API_URL,
    NEXT_PUBLIC_WS_URL: process.env.NEXT_PUBLIC_WS_URL,
  },
  images: {
    domains: ['cdn.example.com'],
  },
}

module.exports = nextConfig
```

---

### 步骤2: 连接Vercel

**方式1: 通过Vercel Dashboard**

1. 访问 https://vercel.com
2. 点击 "New Project"
3. 导入GitHub仓库
4. 选择框架: Next.js (自动检测)
5. 配置环境变量:

```
NEXT_PUBLIC_API_URL=https://api.web3alphahunter.com
NEXT_PUBLIC_WS_URL=wss://api.web3alphahunter.com/ws
```

6. 点击 "Deploy"

**方式2: 通过Vercel CLI**

```bash
# 安装Vercel CLI
npm i -g vercel

# 登录
vercel login

# 部署
cd web3-alpha-hunter-web
vercel

# 生产环境部署
vercel --prod
```

---

### 步骤3: 配置自定义域名

1. 在Vercel项目设置中选择 "Domains"
2. 添加域名: `app.web3alphahunter.com`
3. 配置DNS记录 (Vercel会提供具体指令):

```
Type: CNAME
Name: app
Value: cname.vercel-dns.com
```

4. 等待SSL证书自动配置 (通常1-5分钟)

---

### 步骤4: 配置环境变量 (分环境)

**Preview环境** (用于测试):
```
NEXT_PUBLIC_API_URL=https://api-staging.web3alphahunter.com
```

**Production环境**:
```
NEXT_PUBLIC_API_URL=https://api.web3alphahunter.com
```

---

## 🔧 后端部署 (Railway.app)

### 步骤1: 准备代码

**Dockerfile**:
```dockerfile
FROM python:3.11-slim

WORKDIR /app

# 安装依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制代码
COPY app/ ./app/

# 暴露端口
EXPOSE 8000

# 启动命令
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**railway.toml**:
```toml
[build]
builder = "DOCKERFILE"
dockerfilePath = "Dockerfile"

[deploy]
startCommand = "uvicorn app.main:app --host 0.0.0.0 --port $PORT"
healthcheckPath = "/health"
healthcheckTimeout = 100
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10
```

---

### 步骤2: 部署到Railway

1. 访问 https://railway.app
2. 点击 "New Project" → "Deploy from GitHub repo"
3. 选择后端仓库
4. Railway自动检测Dockerfile并开始构建

---

### 步骤3: 配置环境变量

在Railway Dashboard设置:

```bash
# 数据库
DATABASE_URL=postgresql://user:pass@host:5432/dbname

# Redis
REDIS_URL=redis://default:pass@host:6379

# API密钥
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...
TWITTER_API_KEY=...
TELEGRAM_BOT_TOKEN=...

# 安全
SECRET_KEY=your-super-secret-key-change-this
CORS_ORIGINS=https://app.web3alphahunter.com

# 环境
ENVIRONMENT=production
```

---

### 步骤4: 配置自定义域名

1. 在Railway项目设置中选择 "Settings" → "Domains"
2. 点击 "Generate Domain" 获得Railway域名
3. 添加自定义域名: `api.web3alphahunter.com`
4. 配置DNS:

```
Type: CNAME
Name: api
Value: <your-project>.up.railway.app
```

---

### 步骤5: 配置健康检查

**app/main.py**:
```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/health")
async def health_check():
    """健康检查端点"""
    return {
        "status": "healthy",
        "version": "1.0.0"
    }
```

---

## 🗄️ 数据库部署 (Supabase)

### 步骤1: 创建项目

1. 访问 https://supabase.com
2. 创建新项目: "web3-alpha-hunter"
3. 选择区域: Singapore (亚洲用户) / Ohio (美国用户)
4. 设置数据库密码 (保存到密码管理器)

---

### 步骤2: 运行数据库迁移

**安装Alembic** (数据库迁移工具):
```bash
pip install alembic
```

**初始化Alembic**:
```bash
alembic init alembic
```

**创建迁移脚本**:
```bash
alembic revision --autogenerate -m "Initial schema"
```

**执行迁移**:
```bash
# 本地测试
alembic upgrade head

# 生产环境 (使用Supabase连接字符串)
DATABASE_URL=postgresql://... alembic upgrade head
```

---

### 步骤3: 配置连接池

**app/db/session.py**:
```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

DATABASE_URL = os.getenv("DATABASE_URL")

engine = create_engine(
    DATABASE_URL,
    pool_size=20,           # 连接池大小
    max_overflow=10,        # 额外连接数
    pool_pre_ping=True,     # 连接前检查
    pool_recycle=3600,      # 1小时回收连接
)

SessionLocal = sessionmaker(bind=engine)
```

---

## 🔴 Redis部署 (Upstash)

### 步骤1: 创建Redis实例

1. 访问 https://upstash.com
2. 创建数据库: "web3-alpha-hunter-cache"
3. 选择区域: Global (边缘缓存)
4. 复制连接字符串

---

### 步骤2: 配置Redis客户端

**app/core/redis.py**:
```python
import redis
from app.core.config import settings

redis_client = redis.from_url(
    settings.REDIS_URL,
    decode_responses=True
)

# 测试连接
def test_redis():
    try:
        redis_client.ping()
        print("✅ Redis connected")
    except Exception as e:
        print(f"❌ Redis error: {e}")
```

---

## ⚙️ Celery Worker部署

### 方案1: Railway (推荐)

**创建新服务**:
1. 在Railway项目中点击 "New Service"
2. 选择同一个GitHub仓库
3. 修改启动命令:

```bash
celery -A app.tasks.celery worker --loglevel=info
```

**环境变量**: 与主API服务相同

---

### 方案2: Docker Compose (本地/VPS)

**docker-compose.yml**:
```yaml
version: '3.8'

services:
  api:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    depends_on:
      - redis
      
  celery_worker:
    build: .
    command: celery -A app.tasks.celery worker --loglevel=info
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    depends_on:
      - redis
      
  celery_beat:
    build: .
    command: celery -A app.tasks.celery beat --loglevel=info
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    depends_on:
      - redis
      
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
```

**启动**:
```bash
docker-compose up -d
```

---

## 📦 对象存储 (Cloudflare R2)

### 步骤1: 创建R2 Bucket

1. 登录Cloudflare Dashboard
2. 进入 "R2" → "Create bucket"
3. 命名: `web3-alpha-hunter-assets`
4. 创建API Token

---

### 步骤2: 配置S3兼容客户端

```python
import boto3
from botocore.config import Config

s3_client = boto3.client(
    's3',
    endpoint_url='https://<account-id>.r2.cloudflarestorage.com',
    aws_access_key_id=settings.R2_ACCESS_KEY_ID,
    aws_secret_access_key=settings.R2_SECRET_ACCESS_KEY,
    config=Config(signature_version='s3v4')
)

# 上传文件
s3_client.upload_file(
    'whitepaper.pdf',
    'web3-alpha-hunter-assets',
    'whitepapers/project-123.pdf'
)

# 生成公开URL
url = f"https://cdn.example.com/whitepapers/project-123.pdf"
```

---

## 🔒 SSL/HTTPS配置

### Vercel (自动)
- ✅ 自动提供Let's Encrypt证书
- ✅ 自动续期
- ✅ HTTP/2支持

### Railway (自动)
- ✅ 自动HTTPS
- ✅ 自动证书管理

### Cloudflare (推荐额外配置)
1. 添加域名到Cloudflare
2. 设置SSL模式: "Full (strict)"
3. 开启 "Always Use HTTPS"
4. 开启 "Automatic HTTPS Rewrites"

---

## 📊 监控配置

### Sentry (错误追踪)

**前端配置**:
```typescript
// app/layout.tsx
import * as Sentry from "@sentry/nextjs"

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1,
})
```

**后端配置**:
```python
import sentry_sdk
from sentry_sdk.integrations.fastapi import FastApiIntegration

sentry_sdk.init(
    dsn=settings.SENTRY_DSN,
    environment=settings.ENVIRONMENT,
    traces_sample_rate=0.1,
    integrations=[FastApiIntegration()]
)
```

---

### Better Stack (日志管理)

```python
import logging
from logtail import LogtailHandler

handler = LogtailHandler(source_token=settings.LOGTAIL_TOKEN)
logger = logging.getLogger(__name__)
logger.addHandler(handler)

logger.info("Application started", extra={
    "environment": settings.ENVIRONMENT,
    "version": "1.0.0"
})
```

---

## 🔄 CI/CD配置

### GitHub Actions

**.github/workflows/deploy.yml**:
```yaml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Run tests
        run: |
          pip install -r requirements.txt
          pytest
          
  deploy-frontend:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          
  deploy-backend:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Railway
        run: |
          npm i -g @railway/cli
          railway up --service backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
```

---

## 🧪 环境管理

### 三套环境

| 环境 | 用途 | 域名 | 数据库 |
|------|------|------|--------|
| Development | 本地开发 | localhost:3000 | 本地PostgreSQL |
| Staging | 测试 | staging.web3alphahunter.com | Supabase (单独项目) |
| Production | 生产 | app.web3alphahunter.com | Supabase (生产) |

---

## 📋 部署检查清单

**部署前**:
- [ ] 所有测试通过
- [ ] 环境变量已配置
- [ ] 数据库迁移已准备
- [ ] API密钥已设置
- [ ] 监控工具已配置

**部署后**:
- [ ] 健康检查通过 (`/health`)
- [ ] API文档可访问 (`/docs`)
- [ ] 前端页面正常加载
- [ ] WebSocket连接正常
- [ ] 定时任务运行正常
- [ ] 错误日志正常上报
- [ ] 性能监控数据正常

---

## 🚨 回滚策略

### Vercel (一键回滚)
1. 进入项目 → "Deployments"
2. 找到之前的稳定版本
3. 点击 "︙" → "Promote to Production"

### Railway
1. 进入项目 → "Deployments"
2. 选择之前的部署版本
3. 点击 "Redeploy"

### 数据库回滚
```bash
# 回滚到上一个版本
alembic downgrade -1

# 回滚到特定版本
alembic downgrade <revision_id>
```

---

## 💰 成本预估

| 服务 | 方案 | 免费额度 | 付费后 |
|------|------|----------|--------|
| Vercel | Pro | 100GB带宽 | $20/月 |
| Railway | Hobby | $5信用额 | $5起/月 |
| Supabase | Free | 500MB数据库 | $25/月 (Pro) |
| Upstash | Free | 10K命令/天 | $0.2/100K命令 |
| Cloudflare R2 | - | 10GB存储 | $0.015/GB |
| Sentry | Free | 5K错误/月 | $26/月 |

**总计**: 
- 免费阶段: ~$5/月
- 付费阶段: ~$80-100/月

---

**文档版本**: v1.0  
**最后更新**: 2025-10-02

