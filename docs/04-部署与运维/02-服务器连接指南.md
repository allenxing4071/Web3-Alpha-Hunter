# 服务器连接指南

> **最后更新**: 2025-10-04
> **文档版本**: v1.0

---

## 🔐 服务器信息

### 生产服务器

| 项目 | 信息 |
|------|------|
| **IP地址** | `47.253.226.250` |
| **用户名** | `root` |
| **认证方式** | SSH密钥对 |
| **密钥文件** | `VPNKEY.pem` (项目根目录) |
| **SSH端口** | `22` (默认) |

---

## 🚀 快速连接

### 方式1: 使用密钥文件直接连接

```bash
# 确保密钥文件权限正确
chmod 600 VPNKEY.pem

# SSH连接
ssh -i VPNKEY.pem root@47.253.226.250
```

### 方式2: 配置SSH Config (推荐)

编辑 `~/.ssh/config`:

```bash
# 添加以下配置
Host web3-alpha-server
    HostName 47.253.226.250
    User root
    IdentityFile /Users/xinghailong/Documents/soft/faxianjihui/VPNKEY.pem
    ServerAliveInterval 60
    ServerAliveCountMax 3
```

然后可以简化连接:

```bash
ssh web3-alpha-server
```

---

## 📋 常用操作

### 1. 连接到服务器

```bash
ssh -i VPNKEY.pem root@47.253.226.250
```

### 2. 上传文件到服务器

```bash
# 上传单个文件
scp -i VPNKEY.pem local_file.txt root@47.253.226.250:/path/to/destination/

# 上传目录
scp -i VPNKEY.pem -r local_dir/ root@47.253.226.250:/path/to/destination/
```

### 3. 从服务器下载文件

```bash
# 下载单个文件
scp -i VPNKEY.pem root@47.253.226.250:/path/to/remote_file.txt ./

# 下载目录
scp -i VPNKEY.pem -r root@47.253.226.250:/path/to/remote_dir/ ./
```

### 4. 使用rsync同步文件

```bash
# 同步本地到服务器
rsync -avz -e "ssh -i VPNKEY.pem" ./backend/ root@47.253.226.250:/app/backend/

# 同步服务器到本地
rsync -avz -e "ssh -i VPNKEY.pem" root@47.253.226.250:/app/backend/ ./backend/
```

---

## 🔧 服务器环境检查

### 连接后首次检查

```bash
# 1. 检查系统信息
cat /etc/os-release
uname -a

# 2. 检查磁盘空间
df -h

# 3. 检查内存
free -h

# 4. 检查CPU
lscpu

# 5. 检查运行的服务
systemctl list-units --type=service --state=running

# 6. 检查Docker
docker --version
docker ps

# 7. 检查网络
ip addr
netstat -tulpn
```

---

## 📦 项目部署路径建议

```bash
# 创建应用目录
ssh -i VPNKEY.pem root@47.253.226.250 << 'EOF'
  mkdir -p /app/web3-alpha-hunter
  mkdir -p /app/web3-alpha-hunter/backend
  mkdir -p /app/web3-alpha-hunter/frontend
  mkdir -p /app/web3-alpha-hunter/data
  mkdir -p /app/web3-alpha-hunter/logs
  mkdir -p /app/web3-alpha-hunter/backups
EOF
```

**推荐目录结构:**
```
/app/web3-alpha-hunter/
├── backend/          # 后端代码
├── frontend/         # 前端代码 (可选)
├── data/             # 数据文件
├── logs/             # 日志文件
├── backups/          # 备份文件
└── docker-compose.yml
```

---

## 🐳 Docker部署示例

### 1. 上传docker-compose.yml

```bash
scp -i VPNKEY.pem docker-compose.yml root@47.253.226.250:/app/web3-alpha-hunter/
```

### 2. 上传环境变量文件

```bash
scp -i VPNKEY.pem backend/.env root@47.253.226.250:/app/web3-alpha-hunter/backend/
```

### 3. SSH到服务器并启动服务

```bash
ssh -i VPNKEY.pem root@47.253.226.250

# 进入项目目录
cd /app/web3-alpha-hunter

# 拉取镜像
docker-compose pull

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f
```

---

## 🔒 安全建议

### 1. 密钥文件安全

```bash
# ⚠️ 确保密钥文件权限正确
chmod 600 VPNKEY.pem

# ⚠️ 不要将密钥文件提交到Git
# 检查 .gitignore 是否包含
cat .gitignore | grep VPNKEY.pem
```

### 2. 配置防火墙

```bash
ssh -i VPNKEY.pem root@47.253.226.250

# 安装ufw
apt update && apt install ufw -y

# 允许SSH
ufw allow 22/tcp

# 允许HTTP/HTTPS
ufw allow 80/tcp
ufw allow 443/tcp

# 允许后端API端口 (例如8000)
ufw allow 8000/tcp

# 启用防火墙
ufw enable

# 查看状态
ufw status
```

### 3. 设置SSH密钥登录后禁用密码登录

```bash
ssh -i VPNKEY.pem root@47.253.226.250

# 编辑SSH配置
vi /etc/ssh/sshd_config

# 修改以下配置
# PasswordAuthentication no
# PubkeyAuthentication yes

# 重启SSH服务
systemctl restart sshd
```

### 4. 创建非root用户 (推荐)

```bash
# 创建部署用户
useradd -m -s /bin/bash deployer
passwd deployer

# 添加sudo权限
usermod -aG sudo deployer

# 复制SSH密钥授权
mkdir -p /home/deployer/.ssh
cp /root/.ssh/authorized_keys /home/deployer/.ssh/
chown -R deployer:deployer /home/deployer/.ssh
chmod 700 /home/deployer/.ssh
chmod 600 /home/deployer/.ssh/authorized_keys
```

---

## 📊 服务器监控

### 实时监控命令

```bash
# CPU和内存监控
htop

# 磁盘IO监控
iotop

# 网络监控
iftop

# Docker容器监控
docker stats

# 查看进程
ps aux | grep python
ps aux | grep node
```

### 日志查看

```bash
# 系统日志
journalctl -xe

# Docker日志
docker-compose logs -f --tail=100

# Nginx日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

---

## 🔄 常用维护命令

### 重启服务

```bash
# 重启Docker服务
cd /app/web3-alpha-hunter
docker-compose restart

# 重启特定服务
docker-compose restart backend
docker-compose restart frontend

# 完全重建
docker-compose down
docker-compose up -d --build
```

### 更新代码

```bash
# 方式1: 在服务器上git pull
cd /app/web3-alpha-hunter
git pull origin main
docker-compose up -d --build

# 方式2: 从本地推送
rsync -avz -e "ssh -i VPNKEY.pem" \
  --exclude 'node_modules' \
  --exclude '.git' \
  --exclude '__pycache__' \
  ./backend/ root@47.253.226.250:/app/web3-alpha-hunter/backend/
```

### 数据库备份

```bash
# 备份PostgreSQL
ssh -i VPNKEY.pem root@47.253.226.250 << 'EOF'
  docker-compose exec -T postgres pg_dump -U postgres web3_alpha_hunter \
    | gzip > /app/web3-alpha-hunter/backups/db_backup_$(date +%Y%m%d_%H%M%S).sql.gz
EOF

# 下载备份到本地
scp -i VPNKEY.pem root@47.253.226.250:/app/web3-alpha-hunter/backups/*.sql.gz ./backups/
```

---

## 🚨 故障排查

### 1. 无法连接服务器

```bash
# 检查网络
ping 47.253.226.250

# 检查SSH端口
telnet 47.253.226.250 22

# 检查密钥权限
ls -la VPNKEY.pem
# 应该显示: -rw------- (600)
```

### 2. 服务无法访问

```bash
ssh -i VPNKEY.pem root@47.253.226.250

# 检查服务状态
docker-compose ps

# 检查端口监听
netstat -tulpn | grep 8000

# 检查防火墙
ufw status

# 检查日志
docker-compose logs backend --tail=100
```

### 3. 磁盘空间不足

```bash
# 查看磁盘使用
df -h

# 查找大文件
du -sh /* | sort -h

# 清理Docker
docker system prune -a --volumes

# 清理日志
journalctl --vacuum-time=7d
```

---

## 📱 移动端连接

### iOS/iPadOS (使用Termius)

1. 下载Termius应用
2. 添加新主机:
   - Label: Web3 Alpha Server
   - Hostname: 47.253.226.250
   - Username: root
3. 添加密钥:
   - 复制VPNKEY.pem内容
   - 粘贴到Termius

### Android (使用JuiceSSH)

1. 下载JuiceSSH应用
2. 创建新连接
3. 导入SSH密钥

---

## 📋 快速命令备忘录

```bash
# 连接
ssh -i VPNKEY.pem root@47.253.226.250

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 重启服务
docker-compose restart

# 进入容器
docker-compose exec backend bash

# 查看资源使用
htop

# 查看磁盘
df -h
```

---

## 🔗 相关文档

- [部署指南](./01-部署指南.md) - 完整部署流程
- [数据库设计文档](../02-技术实现/04-数据库设计文档.md) - 数据��备份恢复

---

## ⚠️ 重要提醒

1. **密钥安全**
   - ❌ 不要将VPNKEY.pem提交到Git
   - ❌ 不要通过不安全的渠道分享密钥
   - ✅ 定期轮换SSH密钥

2. **服务器安全**
   - ✅ 定期更新系统: `apt update && apt upgrade`
   - ✅ 启用防火墙
   - ✅ 禁用密码登录
   - ✅ 使用非root用户部署

3. **数据备份**
   - ✅ 每日自动备份数据库
   - ✅ 备份到异地存储
   - ✅ 定期测试备份恢复

---

**文档版本**: v1.0
**最后更新**: 2025-10-04
**维护者**: 运维团队
