# 服务器环境详情

> **最后更新**: 2025-10-04
> **文档版本**: v1.0
> **服务器IP**: 47.253.226.250

---

## 📊 服务器概览

### 基本信息

| 项目 | 信息 |
|------|------|
| **云服务商** | 阿里云 (Alibaba Cloud) |
| **服务类型** | ECS (Elastic Compute Service) |
| **操作系统** | Ubuntu 24.04.2 LTS (Noble Numbat) |
| **内核版本** | Linux 6.8.0-60-generic |
| **架构** | x86_64 |

### 硬件配置

| 资源 | 配置 |
|------|------|
| **CPU** | 2核 Intel Xeon Platinum (2线程/核) |
| **内存** | 1.6 GB |
| **磁盘** | 40 GB (已使用 15GB, 39%) |
| **网络** | IPv4: 172.22.48.20 (内网) |
| | IPv4: 47.253.226.250 (公网) |

### 当前状态 (2025-10-04)

| 指标 | 数值 |
|------|------|
| **系统负载** | 0.47 |
| **内存使用** | 80% (1.4GB/1.6GB) ⚠️ |
| **磁盘使用** | 37.1% (15GB/40GB) |
| **Swap使用** | 0% |
| **运行进程** | 129个 |
| **登录用户** | 0 |

⚠️ **注意**: 内存使用率较高(80%),建议监控或升级配置

---

## 🔧 已安装软件

### 核心服务

| 软件 | 版本 | 状态 |
|------|------|------|
| **Docker** | 28.3.2 (build 578ccf6) | ✅ 已安装 |
| **Nginx** | - | ✅ 运行中 |
| **PostgreSQL** | - | ❓ 未检测到 |
| **Redis** | - | ❓ 未检测到 |
| **Python** | - | ❓ 未检测到 |

### Docker容器状态

```bash
# 当前无运行中的容器
docker ps
# NAMES     STATUS    PORTS
```

---

## 📁 推荐目录结构

### 应用部署目录

```bash
/app/
└── web3-alpha-hunter/
    ├── backend/              # 后端应用
    ├── frontend/             # 前端应用 (可选)
    ├── data/                 # 数据文件
    │   ├── postgresql/       # PostgreSQL数据
    │   └── redis/            # Redis数据
    ├── logs/                 # 应用日志
    │   ├── backend/
    │   ├── nginx/
    │   └── celery/
    ├── backups/              # 数据备份
    │   └── postgresql/
    ├── ssl/                  # SSL证书
    ├── docker-compose.yml    # Docker编排文件
    └── .env                  # 环境变量
```

### 创建目录命令

```bash
ssh -i VPNKEY.pem root@47.253.226.250 << 'EOF'
  mkdir -p /app/web3-alpha-hunter/{backend,frontend,data/{postgresql,redis},logs/{backend,nginx,celery},backups/postgresql,ssl}
  chmod -R 755 /app/web3-alpha-hunter
  echo "目录结构创建完成"
EOF
```

---

## 🐳 Docker Compose配置建议

### 推荐的docker-compose.yml

```yaml
version: '3.8'

services:
  # PostgreSQL数据库
  postgres:
    image: postgres:15-alpine
    container_name: web3_postgres
    restart: always
    environment:
      POSTGRES_DB: web3_alpha_hunter
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - /app/web3-alpha-hunter/data/postgresql:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5432:5432"
    networks:
      - web3_network

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: web3_redis
    restart: always
    command: redis-server --appendonly yes
    volumes:
      - /app/web3-alpha-hunter/data/redis:/data
    ports:
      - "127.0.0.1:6379:6379"
    networks:
      - web3_network

  # 后端API
  backend:
    build: ./backend
    container_name: web3_backend
    restart: always
    environment:
      DATABASE_URL: postgresql://postgres:${DB_PASSWORD}@postgres:5432/web3_alpha_hunter
      REDIS_URL: redis://redis:6379
    volumes:
      - ./backend:/app
      - /app/web3-alpha-hunter/logs/backend:/app/logs
    ports:
      - "127.0.0.1:8000:8000"
    depends_on:
      - postgres
      - redis
    networks:
      - web3_network

  # Celery Worker
  celery_worker:
    build: ./backend
    container_name: web3_celery
    restart: always
    command: celery -A app.tasks.celery worker --loglevel=info
    environment:
      DATABASE_URL: postgresql://postgres:${DB_PASSWORD}@postgres:5432/web3_alpha_hunter
      REDIS_URL: redis://redis:6379
    volumes:
      - ./backend:/app
      - /app/web3-alpha-hunter/logs/celery:/app/logs
    depends_on:
      - postgres
      - redis
    networks:
      - web3_network

  # Nginx反向代理
  nginx:
    image: nginx:alpine
    container_name: web3_nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - /app/web3-alpha-hunter/ssl:/etc/nginx/ssl:ro
      - /app/web3-alpha-hunter/logs/nginx:/var/log/nginx
    depends_on:
      - backend
    networks:
      - web3_network

networks:
  web3_network:
    driver: bridge
```

---

## 🔒 安全加固建议

### 1. 防火墙配置

```bash
# 安装并配置ufw
ssh -i VPNKEY.pem root@47.253.226.250 << 'EOF'
  # 安装ufw
  apt update && apt install -y ufw

  # 默认规则
  ufw default deny incoming
  ufw default allow outgoing

  # 允许SSH (重要!)
  ufw allow 22/tcp

  # 允许HTTP/HTTPS
  ufw allow 80/tcp
  ufw allow 443/tcp

  # 启用防火墙
  echo "y" | ufw enable

  # 查看状态
  ufw status verbose
EOF
```

### 2. 禁用密码登录

```bash
ssh -i VPNKEY.pem root@47.253.226.250 << 'EOF'
  # 备份配置
  cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak

  # 修改配置
  sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
  sed -i 's/PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config

  # 重启SSH
  systemctl restart sshd

  echo "密码登录已禁用,仅允许密钥登录"
EOF
```

### 3. 自动安全更新

```bash
ssh -i VPNKEY.pem root@47.253.226.250 << 'EOF'
  # 安装自动更新
  apt install -y unattended-upgrades

  # 启用自动更新
  dpkg-reconfigure -plow unattended-upgrades

  echo "自动安全更新已启用"
EOF
```

---

## 📈 监控配置

### 1. 安装监控工具

```bash
ssh -i VPNKEY.pem root@47.253.226.250 << 'EOF'
  # 安装htop (进程监控)
  apt install -y htop

  # 安装iotop (IO监控)
  apt install -y iotop

  # 安装iftop (网络监控)
  apt install -y iftop

  # 安装netdata (实时监控面板)
  bash <(curl -Ss https://my-netdata.io/kickstart.sh) --dont-wait
EOF
```

### 2. Docker监控

```bash
# 安装ctop (Docker容器监控)
ssh -i VPNKEY.pem root@47.253.226.250 << 'EOF'
  wget https://github.com/bcicen/ctop/releases/download/v0.7.7/ctop-0.7.7-linux-amd64 -O /usr/local/bin/ctop
  chmod +x /usr/local/bin/ctop
  echo "ctop已安装,使用命令: ctop"
EOF
```

---

## 🔄 系统维护脚本

### 自动备份脚本

创建 `/app/web3-alpha-hunter/scripts/backup.sh`:

```bash
#!/bin/bash
# 数据库备份脚本

BACKUP_DIR="/app/web3-alpha-hunter/backups/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="db_backup_${DATE}.sql.gz"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
docker-compose exec -T postgres pg_dump -U postgres web3_alpha_hunter | gzip > "${BACKUP_DIR}/${BACKUP_FILE}"

# 保留最近7天的备份
find $BACKUP_DIR -name "db_backup_*.sql.gz" -mtime +7 -delete

echo "备份完成: ${BACKUP_FILE}"
```

### 设置定时任务

```bash
ssh -i VPNKEY.pem root@47.253.226.250 << 'EOF'
  # 添加到crontab
  (crontab -l 2>/dev/null; echo "0 2 * * * /app/web3-alpha-hunter/scripts/backup.sh >> /app/web3-alpha-hunter/logs/backup.log 2>&1") | crontab -

  echo "每日凌晨2点自动备份已设置"
EOF
```

---

## 📊 性能优化建议

### 1. 内存优化

**当前问题**: 内存使用率80%,可用内存仅200MB

**解决方案**:
1. **升级服务器配置** (推荐)
   - 建议升级到至少 4GB 内存
   - 当前1.6GB对于运行多个Docker容器偏小

2. **优化Docker内存限制**
   ```yaml
   # 在docker-compose.yml中限制容器内存
   services:
     backend:
       mem_limit: 512m
       mem_reservation: 256m
   ```

3. **启用Swap** (临时方案)
   ```bash
   ssh -i VPNKEY.pem root@47.253.226.250 << 'EOF'
     # 创建2GB swap
     fallocate -l 2G /swapfile
     chmod 600 /swapfile
     mkswap /swapfile
     swapon /swapfile
     echo '/swapfile none swap sw 0 0' >> /etc/fstab
   EOF
   ```

### 2. 磁盘空间监控

```bash
# 设置磁盘使用告警
ssh -i VPNKEY.pem root@47.253.226.250 << 'EOF'
  cat > /usr/local/bin/disk-alert.sh << 'SCRIPT'
#!/bin/bash
THRESHOLD=80
USAGE=$(df -h / | tail -1 | awk '{print $5}' | sed 's/%//')

if [ $USAGE -gt $THRESHOLD ]; then
  echo "警告: 磁盘使用率 ${USAGE}% 超过阈值 ${THRESHOLD}%"
  # 这里可以添加发送邮件或其他通知的代码
fi
SCRIPT

  chmod +x /usr/local/bin/disk-alert.sh

  # 每小时检查一次
  (crontab -l 2>/dev/null; echo "0 * * * * /usr/local/bin/disk-alert.sh >> /var/log/disk-alert.log 2>&1") | crontab -
EOF
```

---

## 🚀 快速部署命令

### 一键部署脚本

```bash
#!/bin/bash
# 项目部署脚本

echo "开始部署Web3 Alpha Hunter..."

# 1. 创建目录结构
ssh -i VPNKEY.pem root@47.253.226.250 "mkdir -p /app/web3-alpha-hunter/{backend,data,logs,backups}"

# 2. 上传文件
rsync -avz -e "ssh -i VPNKEY.pem" \
  --exclude 'node_modules' \
  --exclude '__pycache__' \
  --exclude '.git' \
  ./docker-compose.yml \
  ./backend/ \
  root@47.253.226.250:/app/web3-alpha-hunter/

# 3. 启动服务
ssh -i VPNKEY.pem root@47.253.226.250 << 'EOF'
  cd /app/web3-alpha-hunter
  docker-compose up -d
  docker-compose ps
EOF

echo "部署完成!"
```

---

## 📋 待办清单

### 紧急 (需立即处理)
- [ ] ⚠️ **升级服务器内存** - 当前1.6GB偏小,建议升级到4GB
- [ ] 🔒 **配置防火墙** - 限制不必要的端口访问
- [ ] 🔐 **禁用密码登录** - 提高SSH安全性

### 重要 (本周完成)
- [ ] 📦 **部署应用** - 使用Docker Compose部署
- [ ] 🔄 **设置自动备份** - 每日备份数据库
- [ ] 📊 **安装监控工具** - Netdata或其他监控方案
- [ ] 🌐 **配置域名** - 将域名指向服务器IP

### 一般 (本月完成)
- [ ] 📜 **配置SSL证书** - Let's Encrypt自动续期
- [ ] 🔔 **设置告警** - 磁盘/内存/CPU告警
- [ ] 📚 **编写部署文档** - 详细的部署SOP
- [ ] 🧪 **压力测试** - 验证服务器性能

---

## 🔗 相关文档

- [服务器连接指南](./02-服务器连接指南.md) - SSH连接和常用命令
- [部署指南](./01-部署指南.md) - 完整部署流程
- [数据库设计文档](../02-技术实现/04-数据库设计文档.md) - 数据库配置

---

## 📞 技术支持

### 阿里云支持
- **控制台**: https://ecs.console.aliyun.com
- **工单系统**: https://workorder.console.aliyun.com
- **文档中心**: https://help.aliyun.com

---

**文档版本**: v1.0
**最后更新**: 2025-10-04
**服务器检测时间**: 2025-10-04 09:21:03 CST
