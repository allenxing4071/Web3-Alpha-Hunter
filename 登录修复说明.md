# 登录功能修复说明

## 📋 问题描述

用户报告无法登录系统，前端控制台显示错误：
```
POST http://localhost:8000/api/v1/api/v1/users/login 404 (Not Found)
```

## 🔍 问题分析

### 问题1：API路径重复
- **现象**：API路径出现两次 `/api/v1/api/v1/`
- **原因**：环境变量和代码中都配置了 `/api/v1` 前缀
  - `.env.local`: `NEXT_PUBLIC_API_URL=http://localhost:8000/api/v1` ❌
  - `api.ts`: `baseURL: ${API_URL}/api/v1` ❌
  - 结果：`http://localhost:8000/api/v1` + `/api/v1` + `/users/login` = 404

### 问题2：管理员密码失效
- **现象**：即使修复API路径，登录仍失败提示"用户名或密码错误"
- **原因**：数据库中的密码哈希可能被修改或损坏

## ✅ 解决方案

### 1. 修复API路径重复问题

**修改前** (`.env.local`):
```bash
NEXT_PUBLIC_API_URL=http://localhost:8000/api/v1
```

**修改后**:
```bash
NEXT_PUBLIC_API_URL=http://localhost:8000
```

**说明**：移除环境变量中的 `/api/v1`，让 `api.ts` 中统一添加

### 2. 重置管理员密码

创建密码重置脚本 `backend/reset_admin_password.py`：
```python
#!/usr/bin/env python3
"""重置管理员密码"""
import bcrypt
from sqlalchemy import create_engine, text
from app.core.config import settings

def hash_password(password: str) -> str:
    return bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')

def reset_admin_password():
    engine = create_engine(settings.DATABASE_URL)
    new_password = "admin123"
    hashed = hash_password(new_password)
    
    with engine.connect() as conn:
        conn.execute(
            text("UPDATE users SET password_hash = :hash, is_active = true WHERE username = 'admin'"),
            {"hash": hashed}
        )
        conn.commit()
```

**使用方法**：
```bash
cd backend
python3 reset_admin_password.py
```

### 3. 重启前端服务

```bash
# 停止现有前端
pkill -f "next dev"

# 重启前端（应用新的环境变量）
cd frontend
npm run dev
```

## 🧪 验证步骤

### 1. API层面测试
```bash
curl -X POST http://localhost:8000/api/v1/users/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

**期望输出**：
```json
{
  "success": true,
  "message": "登录成功",
  "user": {
    "id": "admin-default-001",
    "username": "admin",
    "role": "admin"
  },
  "token": "..."
}
```

### 2. 前端测试
1. 打开浏览器访问 http://localhost:3000
2. 输入凭据：
   - 用户名：`admin`
   - 密码：`admin123`
3. 点击"登录"按钮
4. 应该成功进入系统

### 3. 浏览器控制台检查
打开开发者工具，查看Network标签：
- ✅ 正确：`POST http://localhost:8000/api/v1/users/login`
- ❌ 错误：`POST http://localhost:8000/api/v1/api/v1/users/login`

## 📊 测试结果

```bash
🔐 测试登录流程
================

1️⃣ 测试登录API...
✅ 登录成功
   用户: admin
   角色: admin
   Token: admin-default-001:admin:admin...

2️⃣ 测试前端访问...
✅ 前端正常运行

3️⃣ 测试后端健康...
✅ 后端状态: healthy

🎉 所有服务正常！
```

## 🔐 默认登录凭据

```
用户名: admin
密码: admin123
角色: 管理员
```

## 📝 注意事项

1. **环境变量修改**：修改 `.env.local` 后必须重启前端服务
2. **密码安全**：生产环境中应修改默认密码
3. **API路径**：确保环境变量和代码中不重复配置路径前缀
4. **密码重置**：如果再次无法登录，运行 `reset_admin_password.py` 脚本

## 🔧 快速修复命令

如果将来再次遇到登录问题：

```bash
# 一键修复脚本
cd /Users/xinghailong/Documents/soft/faxianjihui

# 1. 重置密码
cd backend && python3 reset_admin_password.py

# 2. 检查环境变量
cd ../frontend
grep NEXT_PUBLIC_API_URL .env.local

# 3. 如果包含 /api/v1，则修复
echo "NEXT_PUBLIC_API_URL=http://localhost:8000" > .env.local.tmp
echo "NEXT_PUBLIC_BACKEND_URL=http://localhost:8000" >> .env.local.tmp
mv .env.local.tmp .env.local

# 4. 重启服务
pkill -f "next dev"
npm run dev
```

## 📈 影响范围

- ✅ 修复登录功能
- ✅ 统一API路径配置
- ✅ 增加密码重置工具
- ✅ 无其他功能影响

## 📅 修复时间

2025-10-06 完成

