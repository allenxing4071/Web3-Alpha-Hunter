# 🔧 数据库未连接 - 解决方案

## 📊 当前状态

**问题**: 数据库管理UI显示表数量没有变化（仍然是5张表）

**原因**: PostgreSQL数据库未运行，无法连接

**错误信息**:
```
connection to server at "localhost" (127.0.0.1), port 5432 failed: Connection refused
Is the server running on that host and accepting TCP/IP connections?
```

---

## ✅ 解决方案

### 方案1: 启动PostgreSQL数据库 (推荐)

#### MacOS

**检查PostgreSQL是否已安装**:
```bash
which psql
postgres --version
```

**如果未安装，使用Homebrew安装**:
```bash
brew install postgresql@14
```

**启动PostgreSQL**:
```bash
# 方法1: 使用brew services（推荐）
brew services start postgresql@14

# 方法2: 手动启动
pg_ctl -D /usr/local/var/postgres start

# 方法3: 如果使用Postgres.app
# 启动Postgres.app应用程序
```

**验证PostgreSQL已启动**:
```bash
psql -U postgres -c "SELECT version();"
```

**创建数据库**:
```bash
# 连接到PostgreSQL
psql -U postgres

# 创建数据库
CREATE DATABASE web3_alpha_hunter;

# 创建用户（如果需要）
CREATE USER web3_user WITH PASSWORD 'your_password';

# 授权
GRANT ALL PRIVILEGES ON DATABASE web3_alpha_hunter TO web3_user;

# 退出
\q
```

**运行数据库迁移**:
```bash
cd backend
python3 -m alembic upgrade head
```

---

### 方案2: 使用Docker运行PostgreSQL (简单快速)

**启动PostgreSQL容器**:
```bash
docker run -d \
  --name web3-postgres \
  -e POSTGRES_DB=web3_alpha_hunter \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=postgres \
  -p 5432:5432 \
  postgres:14-alpine
```

**验证容器运行**:
```bash
docker ps | grep web3-postgres
```

**运行数据库迁移**:
```bash
cd backend
python3 -m alembic upgrade head
```

**停止容器**（不需要时）:
```bash
docker stop web3-postgres
```

**重启容器**:
```bash
docker start web3-postgres
```

---

### 方案3: 使用SQLite (临时测试方案)

如果不想安装PostgreSQL，可以临时使用SQLite进行测试。

**修改数据库配置**:

编辑 `backend/app/core/config.py`:
```python
# 原配置
# DATABASE_URL: str = "postgresql://postgres:postgres@localhost:5432/web3_alpha_hunter"

# 改为SQLite
DATABASE_URL: str = "sqlite:///./web3_alpha_hunter.db"
```

**修改alembic配置**:

编辑 `backend/alembic.ini`:
```ini
# 原配置
# sqlalchemy.url = postgresql://postgres:postgres@localhost:5432/web3_alpha_hunter

# 改为SQLite
sqlalchemy.url = sqlite:///./web3_alpha_hunter.db
```

**运行迁移**:
```bash
cd backend
python3 -m alembic upgrade head
```

**注意**: SQLite不支持某些PostgreSQL特性（如JSON类型的高级查询），仅用于开发测试。

---

## 🚀 迁移后验证

### 1. 检查表是否创建成功

**方法1: 使用psql**
```bash
psql -U postgres -d web3_alpha_hunter -c "\dt"
```

**预期输出**:
```
 Schema |           Name            | Type  |  Owner   
--------+---------------------------+-------+----------
 public | ai_analysis               | table | postgres
 public | airdrop_value_estimates   | table | postgres
 public | ai_config                 | table | postgres
 public | investment_action_plans   | table | postgres
 public | onchain_metrics           | table | postgres
 public | project_discoveries       | table | postgres
 public | projects                  | table | postgres
 public | social_metrics            | table | postgres
 public | token_launch_predictions  | table | postgres
```

**现在应该看到9张表**（原来5张 + 新增4张）!

---

### 2. 刷新UI界面

1. 在浏览器中打开数据库管理页面
2. 刷新页面（F5或Cmd+R）
3. 应该看到：
   - **数据表**: 9张（从5张增加到9张）
   - **新增表**: 
     - token_launch_predictions
     - airdrop_value_estimates
     - investment_action_plans
     - project_discoveries

---

### 3. 查看新表结构

**查看所有表的详细信息**:
```sql
SELECT 
    table_name,
    (SELECT COUNT(*) FROM information_schema.columns 
     WHERE table_name = t.table_name) as column_count
FROM information_schema.tables t
WHERE table_schema = 'public'
ORDER BY table_name;
```

**查看特定表的结构**:
```bash
# 发币概率预测表
psql -U postgres -d web3_alpha_hunter -c "\d token_launch_predictions"

# 空投价值估算表
psql -U postgres -d web3_alpha_hunter -c "\d airdrop_value_estimates"

# 投资行动计划表
psql -U postgres -d web3_alpha_hunter -c "\d investment_action_plans"

# 项目发现记录表
psql -U postgres -d web3_alpha_hunter -c "\d project_discoveries"
```

---

## 📝 数据库配置文件

### 当前配置

**配置文件**: `backend/app/core/config.py`

```python
DATABASE_URL: str = Field(
    default="postgresql://postgres:postgres@localhost:5432/web3_alpha_hunter"
)
```

### 修改配置（如果需要）

如果您的PostgreSQL配置不同，请修改：
- **用户名**: postgres → 你的用户名
- **密码**: postgres → 你的密码
- **主机**: localhost → 你的主机
- **端口**: 5432 → 你的端口
- **数据库名**: web3_alpha_hunter → 你的数据库名

---

## 🐛 常见问题

### 问题1: "psql: command not found"
**解决**: PostgreSQL未安装或未添加到PATH
```bash
# MacOS - 添加到PATH
echo 'export PATH="/usr/local/opt/postgresql@14/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc
```

### 问题2: "FATAL: database does not exist"
**解决**: 创建数据库
```bash
createdb web3_alpha_hunter
# 或
psql -U postgres -c "CREATE DATABASE web3_alpha_hunter;"
```

### 问题3: "FATAL: role does not exist"
**解决**: 创建用户
```bash
psql -U postgres -c "CREATE USER your_username WITH PASSWORD 'your_password';"
```

### 问题4: 迁移版本冲突
**解决**: 查看当前版本并重置
```bash
# 查看当前版本
python3 -m alembic current

# 查看历史
python3 -m alembic history

# 降级到指定版本
python3 -m alembic downgrade <revision>

# 升级到最新
python3 -m alembic upgrade head
```

---

## 🎯 快速启动流程（推荐）

**使用Docker的完整流程**:

```bash
# 1. 启动PostgreSQL
docker run -d \
  --name web3-postgres \
  -e POSTGRES_DB=web3_alpha_hunter \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=postgres \
  -p 5432:5432 \
  postgres:14-alpine

# 2. 等待数据库启动（5-10秒）
sleep 10

# 3. 运行数据库迁移
cd /Users/xinghailong/Documents/soft/faxianjihui/backend
python3 -m alembic upgrade head

# 4. 验证
docker exec web3-postgres psql -U postgres -d web3_alpha_hunter -c "\dt"

# 5. 刷新UI界面
# 在浏览器中刷新 http://localhost:3000 的数据库管理页面
```

**预期结果**:
- ✅ PostgreSQL容器运行
- ✅ 数据库创建成功
- ✅ 9张表创建成功
- ✅ UI界面显示9张表

---

## 📊 迁移前后对比

### 迁移前
```
数据表: 5
├── projects (项目表)
├── social_metrics (社交指标)
├── onchain_metrics (链上数据)
├── ai_analysis (AI分析)
└── ai_config (AI配置)
```

### 迁移后
```
数据表: 9 (+4)
├── projects (项目表)
├── social_metrics (社交指标)
├── onchain_metrics (链上数据)
├── ai_analysis (AI分析)
├── ai_config (AI配置)
├── token_launch_predictions (发币预测) ✨ 新增
├── airdrop_value_estimates (空投估算) ✨ 新增
├── investment_action_plans (行动计划) ✨ 新增
└── project_discoveries (项目发现) ✨ 新增
```

---

## 💡 下一步

迁移成功后：

1. ✅ 数据库结构已更新
2. ✅ UI界面显示9张表
3. ⏳ 更新API接口保存数据到新表
4. ⏳ 前端展示新功能数据
5. ⏳ 集成完整工作流

---

**文档更新**: 2025-10-05  
**解决方案**: 启动PostgreSQL + 运行迁移  
**预期结果**: 从5张表扩展到9张表

