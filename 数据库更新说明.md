# 💾 数据库更新说明

## 📅 更新信息

**更新时间**: 2025-10-05  
**更新版本**: v1.1  
**迁移脚本**: `003_add_prediction_tables.py`

---

## 🆕 新增表结构

### 1. token_launch_predictions (代币发币概率预测表)

**用途**: 存储项目发币概率预测结果

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| project_id | INTEGER | 项目ID（外键） |
| launch_probability | INTEGER | 发币概率 (0-100%) |
| confidence | VARCHAR(20) | 置信度 (Very Low/Low/Medium/High/Very High) |
| estimated_timeline | VARCHAR(100) | 预估时间线 ("1-2个月内"等) |
| detected_signals | JSON | 检测到的信号列表 |
| signal_count | INTEGER | 信号数量 |
| has_snapshot_announced | INTEGER | 是否宣布快照 (0/1) |
| has_tokenomics_published | INTEGER | 是否公布代币经济 (0/1) |
| has_points_system | INTEGER | 是否有积分系统 (0/1) |
| has_audit_completed | INTEGER | 是否完成审计 (0/1) |
| has_mainnet_live | INTEGER | 主网是否上线 (0/1) |
| has_roadmap_token_mention | INTEGER | 路线图是否提及代币 (0/1) |
| predicted_at | TIMESTAMP | 预测时间 |
| updated_at | TIMESTAMP | 更新时间 |

**索引**:
- `idx_prediction_project`: (project_id, predicted_at)
- `idx_prediction_probability`: (launch_probability)

**示例数据**:
```json
{
  "project_id": 1,
  "launch_probability": 65,
  "confidence": "High",
  "estimated_timeline": "2-4个月内",
  "detected_signals": [
    "已宣布快照时间",
    "代币经济学已公开",
    "主网已上线",
    "完成$30M融资"
  ],
  "signal_count": 4
}
```

---

### 2. airdrop_value_estimates (空投价值估算表)

**用途**: 存储空投价值估算结果

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| project_id | INTEGER | 项目ID（外键） |
| estimated_value_usd | INTEGER | 预估价值(美元) |
| estimated_value_cny | INTEGER | 预估价值(人民币) |
| min_value_usd | INTEGER | 最小价值(美元) |
| max_value_usd | INTEGER | 最大价值(美元) |
| confidence | VARCHAR(20) | 置信度 |
| reference_category | VARCHAR(50) | 参考类别 (DeFi/Layer2/NFT) |
| historical_avg | INTEGER | 历史平均值 |
| tvl_adjustment | DECIMAL(5,2) | TVL调整系数 |
| funding_adjustment | DECIMAL(5,2) | 融资调整系数 |
| final_adjustment | DECIMAL(5,2) | 最终调整系数 |
| estimated_at | TIMESTAMP | 估算时间 |
| updated_at | TIMESTAMP | 更新时间 |

**索引**:
- `idx_estimate_project`: (project_id, estimated_at)
- `idx_estimate_value`: (estimated_value_usd)

**示例数据**:
```json
{
  "project_id": 1,
  "estimated_value_usd": 3599,
  "estimated_value_cny": 23394,
  "min_value_usd": 1799,
  "max_value_usd": 7198,
  "confidence": "Medium",
  "reference_category": "Layer2",
  "tvl_adjustment": 1.5,
  "funding_adjustment": 1.4
}
```

---

### 3. investment_action_plans (投资行动计划表)

**用途**: 存储完整的投资行动计划

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| project_id | INTEGER | 项目ID（外键） |
| project_tier | VARCHAR(1) | 项目分级 (S/A/B/C) |
| composite_score | INTEGER | 综合评分 |
| total_budget | INTEGER | 总预算(人民币) |
| budget_breakdown | JSON | 预算明细 |
| start_date | VARCHAR(20) | 开始日期 |
| target_duration | VARCHAR(50) | 预估周期 |
| urgency | VARCHAR(20) | 紧迫性 (Normal/High/Critical) |
| expected_roi | VARCHAR(20) | 预期ROI ("10.0倍") |
| airdrop_estimate | INTEGER | 预估空投(美元) |
| action_steps | JSON | 行动步骤列表 |
| total_steps | INTEGER | 总步骤数 |
| monitoring_metrics | JSON | 监控指标 |
| alert_conditions | JSON | 预警条件 |
| risks | JSON | 风险提示 |
| stop_loss_conditions | JSON | 止损条件 |
| status | VARCHAR(20) | 状态 (active/completed/cancelled) |
| completion_percentage | INTEGER | 完成度 (0-100%) |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

**索引**:
- `idx_plan_project`: (project_id, created_at)
- `idx_plan_status`: (status, project_tier)

**示例数据**:
```json
{
  "project_id": 1,
  "project_tier": "S",
  "composite_score": 85,
  "total_budget": 2828,
  "budget_breakdown": {
    "桥接资产": {"金额": 1414, "说明": "桥接到L2的主要资金"},
    "Dapp交互": {"金额": 565, "说明": "在各Dapp上的操作资金"},
    "Gas费": {"金额": 282, "说明": "L1+L2的Gas费"},
    "应急储备": {"金额": 565, "说明": "灵活应对"}
  },
  "expected_roi": "11.0倍",
  "action_steps": [
    {
      "step_number": 1,
      "action": "创建新钱包或准备专用钱包",
      "deadline": "立即",
      "cost_estimate": "¥0",
      "priority": "high"
    }
  ],
  "status": "active"
}
```

---

### 4. project_discoveries (项目发现记录表)

**用途**: 存储项目发现和热度追踪数据

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| project_name | VARCHAR(255) | 项目名称 |
| total_mentions | INTEGER | 总提及次数 |
| platform_mentions | JSON | 各平台提及数 |
| num_platforms | INTEGER | 覆盖平台数 |
| signal_strength | INTEGER | 信号强度 (0-100) |
| first_discovered_at | TIMESTAMP | 首次发现时间 |
| last_mentioned_at | TIMESTAMP | 最后提及时间 |
| heat_score | INTEGER | 热度分 (0-100) |
| mentions_24h | INTEGER | 24小时提及数 |
| mentions_7d | INTEGER | 7天提及数 |
| growth_rate | DECIMAL(5,2) | 增长率 |
| is_trending | INTEGER | 是否热门 (0/1) |
| is_surge | INTEGER | 是否突发 (0/1) |
| surge_ratio | DECIMAL(5,2) | 突发比率 |
| has_token | INTEGER | 是否已发币 (0/1) |
| mention_samples | JSON | 提及样本 |
| discovery_status | VARCHAR(20) | 发现状态 (new/verified/false_positive) |
| discovered_at | TIMESTAMP | 发现时间 |
| updated_at | TIMESTAMP | 更新时间 |

**索引**:
- `idx_discovery_project_name`: (project_name)
- `idx_discovery_discovered_at`: (discovered_at)
- `idx_discovery_signal`: (signal_strength, discovered_at)
- `idx_discovery_heat`: (heat_score, is_trending)

**示例数据**:
```json
{
  "project_name": "ZkFlow Protocol",
  "total_mentions": 15,
  "platform_mentions": {
    "twitter": 8,
    "telegram": 5,
    "medium": 2
  },
  "num_platforms": 3,
  "signal_strength": 85,
  "heat_score": 78,
  "is_trending": 1,
  "discovery_status": "verified"
}
```

---

## 📊 数据库架构概览

```
┌─────────────────────┐
│     projects        │  主表
│  (现有8个项目)       │
└──────────┬──────────┘
           │
           ├─────────────────────────────────────┐
           │                                     │
           ▼                                     ▼
┌──────────────────────┐            ┌────────────────────────┐
│ token_launch_        │            │ airdrop_value_         │
│ predictions          │            │ estimates              │
│ (发币概率预测)        │            │ (空投价值估算)          │
└──────────────────────┘            └────────────────────────┘
           │
           ▼
┌──────────────────────┐            ┌────────────────────────┐
│ investment_action_   │            │ project_               │
│ plans                │            │ discoveries            │
│ (投资行动计划)        │            │ (项目发现记录)          │
└──────────────────────┘            └────────────────────────┘
```

---

## 🔄 数据库迁移步骤

### 1. 备份现有数据库
```bash
# PostgreSQL备份
pg_dump -U postgres -d web3_alpha_hunter > backup_$(date +%Y%m%d).sql
```

### 2. 运行迁移
```bash
cd backend
alembic upgrade head
```

### 3. 验证迁移
```bash
# 检查表是否创建成功
psql -U postgres -d web3_alpha_hunter -c "\dt"

# 检查每张表的结构
psql -U postgres -d web3_alpha_hunter -c "\d token_launch_predictions"
psql -U postgres -d web3_alpha_hunter -c "\d airdrop_value_estimates"
psql -U postgres -d web3_alpha_hunter -c "\d investment_action_plans"
psql -U postgres -d web3_alpha_hunter -c "\d project_discoveries"
```

### 4. 回滚（如果需要）
```bash
alembic downgrade -1
```

---

## 🎯 使用示例

### 保存发币概率预测
```python
from app.models import TokenLaunchPrediction
from app.db import SessionLocal

db = SessionLocal()

prediction = TokenLaunchPrediction(
    project_id=1,
    launch_probability=65,
    confidence="High",
    estimated_timeline="2-4个月内",
    detected_signals=["已宣布快照时间", "代币经济学已公开"],
    signal_count=2,
    has_snapshot_announced=1,
    has_tokenomics_published=1
)

db.add(prediction)
db.commit()
```

### 查询项目的行动计划
```python
from app.models import InvestmentActionPlan

plans = db.query(InvestmentActionPlan)\
    .filter(InvestmentActionPlan.project_id == 1)\
    .filter(InvestmentActionPlan.status == "active")\
    .order_by(InvestmentActionPlan.created_at.desc())\
    .all()
```

### 查询热门项目发现
```python
from app.models import ProjectDiscovery

trending = db.query(ProjectDiscovery)\
    .filter(ProjectDiscovery.is_trending == 1)\
    .filter(ProjectDiscovery.has_token == 0)\
    .order_by(ProjectDiscovery.heat_score.desc())\
    .limit(10)\
    .all()
```

---

## 📈 数据统计

### 当前数据库规模

| 表名 | 记录数 | 说明 |
|------|--------|------|
| projects | 8 | 现有项目 |
| social_metrics | 15 | 社交媒体指标 |
| onchain_metrics | 0 | 链上数据 |
| ai_analysis | 0 | AI分析 |
| **token_launch_predictions** | **0** | **新增** |
| **airdrop_value_estimates** | **0** | **新增** |
| **investment_action_plans** | **0** | **新增** |
| **project_discoveries** | **0** | **新增** |

### 预计数据增长

**每日新增**:
- 项目发现: 10-20条
- 发币预测: 5-10条
- 空投估算: 5-10条
- 行动计划: 2-5条

**每月数据量**:
- 项目发现: ~450条
- 其他表: ~200条

---

## 🔧 性能优化

### 已添加索引

1. **复合索引**: 提升多条件查询性能
   - `(project_id, created_at)` - 按项目查询历史
   - `(status, project_tier)` - 按状态和分级筛选

2. **单列索引**: 优化常用查询
   - `launch_probability` - 按概率排序
   - `heat_score` - 按热度排序
   - `signal_strength` - 按信号强度筛选

3. **时间戳索引**: 支持时间范围查询
   - `discovered_at`, `predicted_at`, `estimated_at`

### 查询优化建议

```sql
-- ✅ 好的查询（使用索引）
SELECT * FROM token_launch_predictions 
WHERE project_id = 1 
ORDER BY predicted_at DESC 
LIMIT 10;

-- ✅ 好的查询（使用索引）
SELECT * FROM project_discoveries 
WHERE heat_score > 70 AND is_trending = 1
ORDER BY discovered_at DESC;

-- ❌ 避免全表扫描
SELECT * FROM investment_action_plans 
WHERE action_steps::text LIKE '%钱包%';
```

---

## 📝 注意事项

### 1. JSON字段使用
- PostgreSQL的JSON类型支持高效查询
- 可以使用`->`和`->>`操作符提取JSON字段
- 示例: `SELECT action_steps->'0'->>'action' FROM investment_action_plans`

### 2. 时间戳字段
- 所有时间戳使用UTC时区
- 自动设置`created_at`和`updated_at`
- 使用`server_default=func.now()`

### 3. 外键关联
- `project_id`关联到`projects.id`
- 删除项目时需要先处理关联数据
- 建议使用软删除（状态标记）

### 4. 数据清理
```sql
-- 清理30天前的发现记录
DELETE FROM project_discoveries 
WHERE discovered_at < NOW() - INTERVAL '30 days' 
AND discovery_status = 'false_positive';

-- 归档已完成的行动计划
UPDATE investment_action_plans 
SET status = 'archived' 
WHERE status = 'completed' 
AND updated_at < NOW() - INTERVAL '90 days';
```

---

## 🔄 下一步计划

### 近期
- [ ] 更新API接口保存新数据
- [ ] 前端展示发币预测和空投估算
- [ ] 添加行动计划执行追踪

### 中期
- [ ] 添加数据分析视图
- [ ] 实现数据导出功能
- [ ] 优化查询性能

### 长期
- [ ] 数据仓库建设
- [ ] 实时数据同步
- [ ] 机器学习模型训练

---

## 📞 技术支持

**数据库迁移问题**:
- 查看迁移日志: `alembic history`
- 当前版本: `alembic current`
- 回滚: `alembic downgrade -1`

**性能问题**:
- 检查慢查询: 启用PostgreSQL慢查询日志
- 分析查询计划: `EXPLAIN ANALYZE <query>`
- 重建索引: `REINDEX TABLE <table_name>`

---

**更新完成**: 2025-10-05  
**文档版本**: v1.0  
**数据库版本**: 003

